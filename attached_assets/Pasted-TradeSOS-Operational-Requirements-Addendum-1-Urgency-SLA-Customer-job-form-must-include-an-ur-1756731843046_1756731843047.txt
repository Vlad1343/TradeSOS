TradeSOS – Operational Requirements (Addendum)
1) Urgency & SLA
Customer job form must include an urgency selector with options:
emergency_now
urgent_2h
same_day
next_day
Store urgency_sla_minutes on the job for routing/ETAs (e.g., emergency_now=0, urgent_2h=120, same_day=480, next_day=1440).
Priority routing: sort candidate trades by (plan tier → availability → distance) but filter by ability to meet SLA (configurable buffer).
API / Schema
Job(…, urgency:str, urgency_sla_minutes:int)
Validation: require urgency at creation; compute SLA minutes server-side.
2) Geographic Matching by UK Postcodes
Customer → job postcode (e.g., M3 4AB). Parse and store:
postcode_full (e.g., “M3 4AB”)
postcode_area (letters, e.g., “M”)
postcode_district (e.g., “M3”)
lat, lon (geocoding stub; pluggable service)
Trades → coverage selected at sign-up/edit:
Multi-select postcode areas (e.g., M, SK) and optionally districts (e.g., M1, M3).
Persist as arrays for fast matching.
Matching Rule (first pass)
A trade qualifies if:
verified = true
plan_tier in {standard,premium}
job.postcode_area ∈ trade.coverage_areas OR job.postcode_district ∈ trade.coverage_districts
(optional) within radius_km if set (fallback to area/district match)
Use DB indexes on coverage_areas / coverage_districts and postcode_area / postcode_district.
Models (add fields)
Trade(…, coverage_areas: list[str], coverage_districts: list[str], radius_km: Optional[float])
Job(…, postcode_full:str, postcode_area:str, postcode_district:str, lat:float, lon:float)
3) Premium First-Access Window (unchanged but respect geo)
When a job is created:
Notify Premium trades in matching postcodes for X minutes (config PREMIUM_FIRST_ACCESS_MINUTES).
Then notify Standard matches.
Stop notifications once a trade accepts.
4) Acceptance & Live Geo-Tracking (Security)
When a trade accepts a job:
Transition to accepted, set accepted_trade_id.
Start location sharing session for that job (trade → customer only).
Trade app sends periodic GPS pings via /jobs/{id}/location (lat, lon, timestamp).
Customer sees ETA + live map with “On the way” status.
Location sharing ends at in_progress or completed, or if canceled.
API
POST /jobs/{job_id}/accept (trade only; optimistic lock)
POST /jobs/{job_id}/location (trade only; body: lat, lon)
GET /jobs/{job_id}/tracker (customer only; returns last known trade location + ETA)
Privacy: only the assigned customer can view the tracking feed for that job; no historical trail after completion (retain coarse logs for audit if needed).
Models
JobLocationPing(id, job_id, trade_id, lat, lon, created_at) with TTL/retention config.
5) In-App Messaging (Job-Scoped)
Real-time, job-scoped chat between customer and the accepted trade (and Admin if needed).
Use websockets + persistent store; redact PII if needed (config).
API
WS /chat/jobs/{job_id} (auth required; only participants)
Message(id, job_id, sender_user_id, text, attachments[], created_at)
UI
Chat panel on both dashboards once a job is accepted until completed.
6) UX / Forms
Customer – Create Job:
Fields: category, description, photos, postcode, urgency.
Show ETA windows derived from urgency_sla_minutes.
Trade – Sign-up / Settings:
Multi-select postcode areas/districts (typeahead with UK list), skills, availability toggle.
Premium perks banner: explains first-access window for jobs in selected areas.
Customer – Tracking:
Map with trade’s marker, simple ETA (Haversine + speed heuristic), safety tips.
7) Validation & Utilities
UK postcode parser/validator (regex + normalisation).
Pluggable geocode(postcode)->(lat,lon) service (stub now, interface for future API).
SLA feasibility check: estimate travel time (distance / configurable avg speed) ≤ urgency_sla_minutes.
8) Tests (must pass)
Creating a job with emergency_now matches only trades in the same postcode area/district and triggers Premium-first notifications.
Trade with area M but not SK doesn’t receive jobs in SK.
On acceptance, only the assigned customer can subscribe to /tracker and chat channel.
Location pings update tracker; ending the job stops live updates.
Access control: no user outside {customer, accepted_trade, admin} can read a job’s messages or location.
9) Example Endpoints (FastAPI style)
# Create job
POST /jobs
{ "title":"Burst pipe", "category":"plumbing", "desc":"water everywhere",
  "photos":[], "postcode":"M3 4AB", "urgency":"urgent_2h" }

# Trade coverage update
PUT /trades/me/coverage
{ "coverage_areas":["M","SK"], "coverage_districts":["M1","M3"] }

# Accept job
POST /jobs/{job_id}/accept

# Trade → location ping
POST /jobs/{job_id}/location
{ "lat":53.4839, "lon":-2.2446 }

# Customer → tracker
GET /jobs/{job_id}/tracker  # returns last {lat,lon,eta,status}

# Websocket chat
WS /chat/jobs/{job_id}
10) Data Model Diffs (SQLModel)
class Trade(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    user_id: int
    skills: list[str] = Field(sa_column=Column(ARRAY(String)))
    coverage_areas: list[str] = Field(default_factory=list, sa_column=Column(ARRAY(String)))       # e.g., ["M","SK"]
    coverage_districts: list[str] = Field(default_factory=list, sa_column=Column(ARRAY(String)))   # e.g., ["M1","M3"]
    plan_tier: str = Field(default="standard")
    verified: bool = False
    radius_km: float | None = None

class Job(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    customer_id: int
    title: str
    category: str
    desc: str
    photos: list[str] = Field(default_factory=list, sa_column=Column(ARRAY(String)))
    postcode_full: str
    postcode_area: str
    postcode_district: str
    lat: float
    lon: float
    urgency: str  # enum values above
    urgency_sla_minutes: int
    status: str = "posted"
    accepted_trade_id: int | None = None

class Message(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    job_id: int
    sender_user_id: int
    text: str
    created_at: datetime

class JobLocationPing(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    job_id: int
    trade_id: int
    lat: float
    lon: float
    created_at: datetime
11) Config Flags
PREMIUM_FIRST_ACCESS_MINUTES=3
TRACKING_PING_INTERVAL_SEC=15
TRACKING_RETENTION_HOURS=24
AVG_TRAVEL_SPEED_KMH=30
ENABLE_RADIUS_FILTER=false (can enable later)