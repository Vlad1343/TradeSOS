{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="tradesos-form">
        {# top icon and title are now shown inside the rim below so remove duplicate here #}
        
        {% if success %}
        <div class="tradesos-success">
            <i class="fas fa-check-circle" style="margin-right: 10px;"></i>
            Your job request has been submitted! Trades in your area will contact you directly.
        </div>
        {% endif %}

    {# Top rim: emergency sign, title and step indicators (static across steps) #}
    <div class="job-rim" style="max-width:1100px;margin:0 auto 22px;border-radius:10px;padding:20px;background:linear-gradient(180deg,#ffffff,#fbfbfb);box-shadow:0 6px 18px rgba(11,22,38,0.04);border:1px solid rgba(11,22,38,0.06);">
        <div style="text-align:center;">
            <i class="fas fa-exclamation-triangle" style="font-size:96px;color:var(--tradesos-red);margin-bottom:8px;" aria-hidden="true"></i>
            <h2 style="margin:0;font-size:20px;font-weight:800;color:var(--tradesos-black);">EMERGENCY SERVICE REQUEST</h2>
        </div>

        <div style="display:flex;justify-content:center;gap:14px;margin-top:14px;align-items:center;">
            {% for i in range(1,5) %}
                {% set active = (step == i) %}
                <a href="{{ url_for('job_request', step=i, category=selected_category, urgency=urgency) }}" style="text-decoration:none;">
                    <div style="width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid {{ 'var(--tradesos-red)' if active else 'var(--tradesos-gray-dark)' }};background: {{ 'var(--tradesos-red)' if active else 'transparent' }};color: {{ 'var(--tradesos-white)' if active else 'var(--tradesos-black)' }};font-weight:700;font-size:16px;">{{ i }}</div>
                </a>
                {% if i < 4 %}
                    <div style="width:28px;text-align:center;color:var(--tradesos-gray-text);">‚Äî</div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    {# Step-specific content #}
    {% if step == 1 %}
        {# Show the main question after the header and steps #}
        <div style="max-width:980px;margin:0 auto 24px;">
            <h2 style="text-align:center;margin:0 0 24px;color:var(--tradesos-black);font-size:22px;">What type of service do you need?</h2>
        </div>
        {# Categories grid as square buttons (not blue links). Each tile: emoji top-right, large title, short bottom-left description. #}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;max-width:980px;margin:0 auto 18px;">
            {% set categories = [
                ('plumbing','Plumber','üîß','Burst pipes, blocked drains, heating'),
                ('electrical','Electrician','‚ö°','Power outages, dangerous wiring, electrical faults'),
                ('locksmith','Locksmith','üîê','Locked out, broken locks, security issues'),
                ('heating','Gas / Heating','üî•','Boiler breakdowns, gas leaks'),
                ('glazing','Glazier','ü™ü','Smashed windows, emergency boarding, security glazing'),
                ('roofing','Roofer','üè†','Roof replacement, storm damage, drain maintenance')
            ] %}
            {% for key, title, emoji, desc in categories %}
                <button type="button" class="category-btn" data-category="{{ key }}" style="position:relative;background:var(--tradesos-white);border:2px solid var(--tradesos-gray-dark);border-radius:8px;padding:14px 18px;min-height:84px;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;font-weight:800;cursor:pointer;font-family: 'Good Times Rg', 'Open Sans', Arial, sans-serif;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div class="tile-title" style="font-size:18px;">{{ title }}</div>
                            <div style="font-size:22px;line-height:1;">{{ emoji }}</div>
                        </div>
                    <div class="tile-desc" style="margin-top:8px;font-size:13px;color:var(--tradesos-gray-text);text-align:left;">{{ desc }}</div>
                </button>
            {% endfor %}
        </div>

        <div id="err_category" style="color:#b00020;font-size:13px;display:none;text-align:center;margin-top:8px;">Please select the service you need</div>

        {# Urgency question also on step 1 per request. Black centered question and 4 options, 2 per row. #}
    <h2 style="text-align:center;margin:36px 0 8px;color:var(--tradesos-black);font-size:22px;font-weight:800;">How urgent is your problem?</h2>
        <div style="max-width:720px;margin:0 auto 12px;text-align:center;color:var(--tradesos-gray-text);"></div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;max-width:720px;margin:0 auto 18px;">
            <button type="button" class="urgency-btn" data-urgency="emergency_now" style="padding:14px 18px;border-radius:8px;border:2px solid var(--tradesos-gray-dark);background:var(--tradesos-white);text-align:left;font-size:18px;font-family:'Good Times Rg','Open Sans',Arial, sans-serif;min-height:84px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;font-weight:800;"> <strong style="font-size:18px;">üö® Emergency</strong><div class="tile-desc" style="font-size:14px;color:var(--tradesos-gray-text);margin-top:6px;">Immediate danger or security risk</div></button>
            <button type="button" class="urgency-btn" data-urgency="urgent_2h" style="padding:14px 18px;border-radius:8px;border:2px solid var(--tradesos-gray-dark);background:var(--tradesos-white);text-align:left;font-size:18px;font-family:'Good Times Rg','Open Sans',Arial, sans-serif;min-height:84px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;font-weight:800;"> <strong style="font-size:18px;">‚è∞ Urgent</strong><div class="tile-desc" style="font-size:14px;color:var(--tradesos-gray-text);margin-top:6px;">Needs attention within 2 hours</div></button>
            <button type="button" class="urgency-btn" data-urgency="same_day" style="padding:14px 18px;border-radius:8px;border:2px solid var(--tradesos-gray-dark);background:var(--tradesos-white);text-align:left;font-size:18px;font-family:'Good Times Rg','Open Sans',Arial, sans-serif;min-height:84px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;font-weight:800;"> <strong style="font-size:18px;">üìÖ Same day</strong><div class="tile-desc" style="font-size:14px;color:var(--tradesos-gray-text);margin-top:6px;">Required today</div></button>
            <button type="button" class="urgency-btn" data-urgency="next_day" style="padding:14px 18px;border-radius:8px;border:2px solid var(--tradesos-gray-dark);background:var(--tradesos-white);text-align:left;font-size:18px;font-family:'Good Times Rg','Open Sans',Arial, sans-serif;min-height:84px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;font-weight:800;"> <strong style="font-size:18px;">üìã Next day</strong><div class="tile-desc" style="font-size:14px;color:var(--tradesos-gray-text);margin-top:6px;">Can wait until tomorrow</div></button>
        </div>

        <div id="err_urgency" style="color:#b00020;font-size:13px;display:none;text-align:center;margin-top:8px;">Please select the urgency</div>

    <div style="display:flex;justify-content:center;gap:12px;margin-top:40px;">
                <div style="width:100%;display:flex;justify-content:center;">
                    <button type="button" id="wizard-continue" class="tradesos-btn tradesos-btn-primary" style="opacity:0.6;cursor:pointer;" onclick="validateStep1(event)">Continue</button>
                </div>
            </div>


    {% elif step == 2 %}
        {# Step 2: start with brief and detailed description fields (left-aligned). Remove old urgency buttons. #}
    <div style="max-width:720px;margin:0 0 20px 0;text-align:left;">
            <div class="form-group" style="text-align:left;margin-bottom:20px;">
                <label for="short_desc" style="font-size:14px;color:var(--tradesos-black);font-weight:700;">Brief description of the problem</label>
                 <input type="text" id="short_desc" name="short_desc" placeholder="Short summary (e.g., Burst pipe in kitchen)" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;">
                 <div id="err_short_desc" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide a short description</div>
            </div>

            <div class="form-group" style="text-align:left;margin-bottom:20px;">
                <label for="long_desc" style="font-size:14px;color:var(--tradesos-black);font-weight:700;">Detailed description of the problem</label>
                 <textarea id="long_desc" name="long_desc" rows="6" placeholder="Add more details here (what happened, any safety concerns, exact location in property)" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;"></textarea>
                 <div id="err_long_desc" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide a detailed description</div>
            </div>
            
            <div class="form-group" style="text-align:left;margin-bottom:20px;">
                <label for="full_address" style="font-size:14px;color:var(--tradesos-black);font-weight:700;">Full address</label>
                 <input type="text" id="full_address" name="full_address" placeholder="House number/name, street, town" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;">
                 <div id="err_full_address" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide the full address</div>
            </div>
            <div class="form-group" style="text-align:left;margin-bottom:20px;max-width:320px;">
                <label for="postcode" style="font-size:14px;color:var(--tradesos-black);font-weight:700;">Postcode</label>
                 <input type="text" id="postcode" name="postcode" placeholder="e.g., M1 1AA" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;">
                 <div id="err_postcode" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide a postcode</div>
            </div>
            
            
                <div class="form-group" style="text-align:left;margin-bottom:20px;">
                    <label style="font-size:14px;color:var(--tradesos-black);font-weight:700;display:block;margin-bottom:8px;">Photos of the problem (Optional)</label>
                    <div style="max-width:720px;margin:0 auto;text-align:center;">
                        <label id="photosLabel" for="photos_step2" style="display:inline-block;padding:22px;border:2px dashed var(--tradesos-gray-dark);border-radius:10px;text-align:center;cursor:pointer;background:var(--tradesos-white);width:100%;max-width:520px;">
                            <div style="font-size:16px;color:var(--tradesos-black);font-weight:700;">Click to upload photos</div>
                            <div style="font-size:12px;color:var(--tradesos-gray-text);margin-top:6px;">Png, jpg up to 10 mb each</div>
                            <input type="file" id="photos_step2" name="photos_step2" accept="image/png, image/jpeg" multiple style="display:none;">
                        </label>
                        <div id="photosPreviewStep2" style="margin-top:16px;text-align:center;"></div>
                    </div>
                </div>
        </div>

    <div id="step2-controls" style="display:flex;justify-content:center;gap:16px;margin:48px auto 0;max-width:720px;">
                <button type="button" id="wizard-back" class="tradesos-btn tradesos-btn-primary" style="opacity:1;">Back</button>
                <button type="button" id="wizard-continue-step2" class="tradesos-btn tradesos-btn-primary" style="opacity:1;cursor:pointer;" onclick="validateStep2(event)">Continue</button>
            </div>
        </div>

    {% elif step == 3 %}
        <!-- Step 3: Contact details (simplified) -->
        <div style="max-width:720px;margin:0 auto 8px;text-align:center;">
            <div style="min-height:56px;display:flex;align-items:center;justify-content:center;">
                <h3 style="margin:0;color:var(--tradesos-black);font-size:22px;font-weight:800;">Your contact details</h3>
            </div>
        </div>

        <div style="max-width:720px;margin:0 auto 8px;text-align:left;">
            <div class="form-group" style="margin-bottom:16px;">
                <label for="step3_phone" style="font-size:14px;color:var(--tradesos-black);font-weight:700;display:block;">Phone number</label>
                <input type="tel" id="step3_phone" name="step3_phone" placeholder="e.g., 5712 456789" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;">
                <div id="err_step3_phone" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide a phone number</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label for="step3_email" style="font-size:14px;color:var(--tradesos-black);font-weight:700;display:block;">Email address</label>
                <input type="email" id="step3_email" name="step3_email" placeholder="you@example.com" style="width:100%;padding:10px;border:2px solid var(--tradesos-gray-dark);border-radius:6px;font-size:14px;">
                <div id="err_step3_email" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please provide an email address</div>
            </div>
            <div class="form-group" style="margin-bottom:6px;">
                <label for="role_selector" style="font-size:14px;color:var(--tradesos-black);font-weight:700;display:block;margin-bottom:8px;">I am a...</label>
                <div style="max-width:520px;">
                    <div id="role_selector" tabindex="0" style="padding:10px;border-radius:8px;border:2px solid var(--tradesos-gray-dark);background:var(--tradesos-white);cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-family:'Good Times Rg','Open Sans',Arial,sans-serif;">
                        <span id="role_selected_label" style="color:var(--tradesos-gray-text);">Select...</span>
                        <span style="font-size:12px;color:var(--tradesos-gray-text);">‚ñæ</span>
                    </div>
                    <div id="role_options" style="display:none;border:1px solid var(--tradesos-gray-dark);border-radius:8px;padding:6px;margin-top:8px;background:var(--tradesos-white);box-shadow:0 6px 18px rgba(11,22,38,0.04);">
                        <div class="role-option" data-role="homeowner" style="padding:8px;border-radius:6px;cursor:pointer;font-family:'Good Times Rg','Open Sans',Arial,sans-serif;">Homeowner</div>
                        <div class="role-option" data-role="tenant" style="padding:8px;border-radius:6px;cursor:pointer;font-family:'Good Times Rg','Open Sans',Arial,sans-serif;">Tenant</div>
                        <div class="role-option" data-role="landlord" style="padding:8px;border-radius:6px;cursor:pointer;font-family:'Good Times Rg','Open Sans',Arial,sans-serif;">Landlord</div>
                        <div class="role-option" data-role="business" style="padding:8px;border-radius:6px;cursor:pointer;font-family:'Good Times Rg','Open Sans',Arial,sans-serif;">Business</div>
                    </div>
                    <div id="err_step3_role" style="color:#b00020;font-size:13px;display:none;margin-top:6px;">Please select one of the options</div>
                </div>
            </div>
        </div>

        <div id="step3-controls" style="display:flex;justify-content:center;gap:16px;margin:28px auto 0;max-width:720px;">
            <button type="button" id="wizard-back-step3" class="tradesos-btn tradesos-btn-primary" style="opacity:1;">Back</button>
            <button type="button" id="wizard-continue-step3" class="tradesos-btn tradesos-btn-primary" style="cursor:pointer;">Continue</button>
        </div>

        <script>
        // Step 3: persist phone/email and navigate to step 4
        document.addEventListener('DOMContentLoaded', function(){
            const cont = document.getElementById('wizard-continue-step3');
            if(!cont) return;

            // prefill from sessionStorage if present
            try{
                const p = sessionStorage.getItem('job_phone'); if(p) document.getElementById('step3_phone').value = p;
                const e = sessionStorage.getItem('job_email'); if(e) document.getElementById('step3_email').value = e;
                const r = sessionStorage.getItem('job_role'); if(r){
                    document.querySelectorAll('.role-btn').forEach(b=>{
                        if(b.dataset.role === r){ b.style.background = '#C62828'; b.style.color = '#ffffff'; b.style.borderColor = '#C62828'; }
                        else { b.style.background = 'var(--tradesos-white)'; b.style.color = 'var(--tradesos-black)'; b.style.borderColor = 'var(--tradesos-gray-dark)'; }
                    });
                }
            }catch(_){}

            // role selector behavior (single dropdown-like control)
            const roleSelector = document.getElementById('role_selector');
            const roleOptions = document.getElementById('role_options');
            const roleLabel = document.getElementById('role_selected_label');
            let selectedRole = null;
            if(roleSelector){
                roleSelector.addEventListener('click', function(e){
                    e.stopPropagation();
                    if(roleOptions.style.display === 'none') roleOptions.style.display = 'block';
                    else roleOptions.style.display = 'none';
                });
                // keyboard support: enter/space toggles
                roleSelector.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); roleSelector.click(); } });
            }
            document.addEventListener('click', function(){ if(roleOptions) roleOptions.style.display = 'none'; });
            const roleItems = document.querySelectorAll('.role-option');
            roleItems.forEach(item=>{
                item.addEventListener('click', function(e){
                    const r = item.dataset.role;
                    selectedRole = r;
                    roleLabel.textContent = item.textContent;
                    roleLabel.style.color = 'var(--tradesos-black)';
                    roleOptions.style.display = 'none';
                    try{ sessionStorage.setItem('job_role', r); }catch(_){}
                });
            });

            // validation helper for step3
            function showStep3Errors(phoneVal, emailVal, roleVal){
                // clear previous
                ['err_step3_phone','err_step3_email','err_step3_role'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
                const controlsRow = document.getElementById('step3-controls');
                const existing = document.getElementById('step3_general_err'); if(existing) existing.remove();

                if(!phoneVal && !emailVal && !roleVal){
                    const ep = document.getElementById('err_step3_phone'); if(ep) ep.style.display='block';
                    const ee = document.getElementById('err_step3_email'); if(ee) ee.style.display='block';
                    const er = document.getElementById('err_step3_role'); if(er) er.style.display='block';
                    if(controlsRow && controlsRow.parentNode){
                        const err = document.createElement('div'); err.id='step3_general_err'; err.style.color='#b00020'; err.style.textAlign='center'; err.style.marginTop='12px'; err.style.width='100%'; err.textContent='Please complete the required fields before continuing';
                        controlsRow.parentNode.insertBefore(err, controlsRow.nextSibling);
                    }
                    return false;
                }
                return true;
            }

            cont.addEventListener('click', function(){
                const phone = (document.getElementById('step3_phone')||{value:''}).value.trim();
                const email = (document.getElementById('step3_email')||{value:''}).value.trim();
                const roleVal = selectedRole || sessionStorage.getItem('job_role') || '';

                // validate: require at least one of phone/email/role
                if(!showStep3Errors(phone, email, roleVal)){
                    // focus first field
                    if(!phone) { const el=document.getElementById('step3_phone'); if(el) el.focus(); }
                    return;
                }

                try{ if(phone) sessionStorage.setItem('job_phone', phone); else sessionStorage.removeItem('job_phone'); }catch(_){}
                try{ if(email) sessionStorage.setItem('job_email', email); else sessionStorage.removeItem('job_email'); }catch(_){}
                try{ if(roleVal) sessionStorage.setItem('job_role', roleVal); }catch(_){}

                const url = new URL(window.location.href);
                url.searchParams.set('step','4');
                const selectedCategory = {{ (selected_category or '')|tojson }};
                const selectedUrgency = {{ (urgency or '')|tojson }};
                if(selectedCategory) url.searchParams.set('category', selectedCategory);
                if(selectedUrgency) url.searchParams.set('urgency', selectedUrgency);
                window.location.href = url.toString();
            });
            // back button behavior (like step2)
            const backBtn3 = document.getElementById('wizard-back-step3');
            if(backBtn3){
                backBtn3.addEventListener('click', function(){
                    const url = new URL(window.location.href);
                    url.searchParams.set('step','2');
                    const selectedCategory = {{ (selected_category or '')|tojson }};
                    const selectedUrgency = {{ (urgency or '')|tojson }};
                    if(selectedCategory) url.searchParams.set('category', selectedCategory);
                    if(selectedUrgency) url.searchParams.set('urgency', selectedUrgency);
                    window.location.href = url.toString();
                });
            }
        });
        </script>

    {% else %}
        {# step == 4: show the full form (existing submission form). Prefill category & urgency from query params. #}
        <form method="POST" action="/job-request" enctype="multipart/form-data">
            <!-- Contact Details Section -->
            <div class="mb-3">
                <h3>
                    <i class="fas fa-user"></i>Your Contact Details
                </h3>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="name">Your Name *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                </div>
            </div>

            <!-- Emergency Details Section -->
            <div class="mb-3">
                <h3>
                    <i class="fas fa-exclamation-circle"></i>Emergency Details
                </h3>
                
                <div class="form-group">
                    <label for="urgency">How urgent is this? *</label>
                    <select id="urgency" name="urgency" required>
                        <option value="">Choose urgency level...</option>
                        <option value="emergency_now" {% if urgency == 'emergency_now' %}selected{% endif %}>üö® Emergency Now - Immediate help needed</option>
                        <option value="urgent_2h" {% if urgency == 'urgent_2h' %}selected{% endif %}>‚è∞ Urgent - Within 2 hours</option>
                        <option value="same_day" {% if urgency == 'same_day' %}selected{% endif %}>üìÖ Same Day - Within 8 hours</option>
                        <option value="next_day" {% if urgency == 'next_day' %}selected{% endif %}>üìã Next Day - Within 24 hours</option>
                    </select>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="title">What's the problem? *</label>
                        <input type="text" id="title" name="title" placeholder="e.g., Burst pipe flooding kitchen" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Trade Type *</label>
                        <select id="category" name="category" required>
                            <option value="">Select trade type...</option>
                            <option value="plumbing" {{ 'selected' if selected_category == 'plumbing' }}>üîß Plumbing</option>
                            <option value="heating" {{ 'selected' if selected_category == 'heating' }}>üî• Heating & Boilers</option>
                            <option value="electrical" {{ 'selected' if selected_category == 'electrical' }}>‚ö° Electrical</option>
                            <option value="gas" {{ 'selected' if selected_category == 'gas' }}>‚õΩ Gas Safety</option>
                            <option value="roofing" {{ 'selected' if selected_category == 'roofing' }}>üè† Roofing</option>
                            <option value="locksmith" {{ 'selected' if selected_category == 'locksmith' }}>üîê Locksmith</option>
                            <option value="security" {{ 'selected' if selected_category == 'security' }}>üõ°Ô∏è Security Systems</option>
                            <option value="glazing" {{ 'selected' if selected_category == 'glazing' }}>ü™ü Emergency Glazing</option>
                            <option value="tree_surgery" {{ 'selected' if selected_category == 'tree_surgery' }}>üå≥ Tree Surgery</option>
                            <option value="automotive" {{ 'selected' if selected_category == 'automotive' }}>üîß Emergency Mechanic</option>
                            <option value="other" {{ 'selected' if selected_category == 'other' }}>‚ùì Other Emergency</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Describe the problem in detail *</label>
                    <textarea id="description" name="description" rows="4" placeholder="What happened? What's not working? Any safety concerns?" required></textarea>
                </div>
                </div>

                <!-- Address Section -->
                <div class="mb-3">
                <h3>
                    <i class="fas fa-map-marker-alt"></i>Your Full Address
                </h3>
                
                <div class="grid-2 mb-2">
                    <div class="form-group">
                        <label for="house_number">House Number/Name *</label>
                        <input type="text" id="house_number" name="house_number" required>
                    </div>
                    <div class="form-group">
                        <label for="street">Street Name *</label>
                        <input type="text" id="street" name="street" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="town">Town/City *</label>
                        <input type="text" id="town" name="town" required>
                    </div>
                    <div class="form-group">
                        <label for="postcode">Postcode *</label>
                        <input type="text" id="postcode" name="postcode" placeholder="e.g., M1 1AA" required>
                    </div>
                </div>
                
                <div class="tradesos-info">
                    <i class="fas fa-info-circle" aria-hidden="true" style="margin-right:5px;"></i>
                    Provide your complete address so the tradesperson can find you
                </div>
            </div>
            <!-- Photo Upload Section -->
            <div class="mb-3">
                <h3>
                    <i class="fas fa-camera"></i>Photos or Videos (Optional)
                </h3>
                
                <div class="form-group">
                    <input type="file" id="photos" name="photos" multiple accept="image/*,video/*" onchange="previewFiles()">
                    <div class="tradesos-info">
                        <i class="fas fa-info-circle" aria-hidden="true" style="margin-right:5px;"></i>
                        Upload photos or videos to help trades understand the problem better. Max 16MB per file.
                    </div>
                    <div id="filePreview" style="margin-top:15px;"></div>
                </div>
            </div>

            <!-- Terms and Submit -->
            <div class="mb-2">
                <label style="display: flex; align-items: center; font-size: 14px; color: var(--tradesos-gray-text); cursor: pointer;">
                    <input type="checkbox" id="terms" name="terms" required style="margin-right: 10px; transform: scale(1.2);">
                    I agree to share my contact details with verified trade professionals
                </label>
            </div>

            <button type="submit" class="tradesos-btn tradesos-btn-primary tradesos-btn-block">
                <i class="fas fa-paper-plane" style="margin-right: 10px;"></i>GET EMERGENCY HELP NOW
            </button>
        </form>
    {% endif %}
    </div>
</div>

<script>
function previewFiles() {
    const files = document.getElementById('photos').files;
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '';
    
    if (files.length === 0) return;
    
    let previewHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;">';
    for (let i = 0; i < Math.min(files.length, 5); i++) {
        const file = files[i];
        const fileName = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
        const fileType = file.type.startsWith('image/') ? 'image' : 'video';
        const icon = fileType === 'image' ? 'fa-image' : 'fa-video';
        
        previewHtml += `
            <div style="background-color: white; padding: 15px; border-radius: 4px; border: 2px solid var(--tradesos-gray-dark); text-align: center;">
                <i class="fas ${icon}" style="font-size:24px;color:var(--tradesos-red);margin-bottom:8px;"></i>
                <div style="font-size:11px;color:var(--tradesos-gray-text);">${fileName}</div>
            </div>

    previewHtml += '</div>';
    preview.innerHTML = previewHtml;
}
</script>
<script>
// Wizard behavior for step 1: select category and urgency, enable Continue
document.addEventListener('DOMContentLoaded', function(){
    // If user clicked Home before returning, clear stored job request fields now.
    try{
        const shouldClear = sessionStorage.getItem('job_clear_on_return');
        if(shouldClear){
            // remove persisted values but do not clear on ordinary reloads
            try{ sessionStorage.removeItem('job_category'); }catch(_){}
            try{ sessionStorage.removeItem('job_urgency'); }catch(_){}
            try{ sessionStorage.removeItem('job_short_desc'); }catch(_){}
            try{ sessionStorage.removeItem('job_long_desc'); }catch(_){}
            try{ sessionStorage.removeItem('job_full_address'); }catch(_){}
            try{ sessionStorage.removeItem('job_postcode'); }catch(_){}
            try{ sessionStorage.removeItem('job_phone'); }catch(_){}
            try{ sessionStorage.removeItem('job_email'); }catch(_){}
            try{ sessionStorage.removeItem('job_role'); }catch(_){}
            // clear UI selections
            try{
                document.querySelectorAll('.category-btn').forEach(b=>{
                    b.style.background = 'var(--tradesos-white)';
                    b.style.color = 'var(--tradesos-black)';
                    b.style.borderColor = 'var(--tradesos-gray-dark)';
                    const title = b.querySelector('.tile-title'); if(title) title.style.color='var(--tradesos-black)';
                    const desc = b.querySelector('.tile-desc'); if(desc) desc.style.color='var(--tradesos-gray-text)';
                });
                document.querySelectorAll('.urgency-btn').forEach(b=>{
                    b.style.background = 'var(--tradesos-white)';
                    b.style.color = 'var(--tradesos-black)';
                    b.style.borderColor = 'var(--tradesos-gray-dark)';
                    const title = b.querySelector('strong'); if(title) title.style.color='var(--tradesos-black)';
                    const desc = b.querySelector('.tile-desc'); if(desc) desc.style.color='var(--tradesos-gray-text)';
                });
                // clear inputs and previews on step 2 if present
                ['short_desc','long_desc','full_address','postcode'].forEach(id=>{
                    const el = document.getElementById(id); if(el) el.value = '';
                    const err = document.getElementById('err_'+id); if(err) err.style.display='none';
                });
                // clear step3 inputs if present
                try{ const sp = document.getElementById('step3_phone'); if(sp) sp.value = ''; }catch(_){ }
                try{ const se = document.getElementById('step3_email'); if(se) se.value = ''; }catch(_){ }
                try{ document.querySelectorAll('.role-btn').forEach(b=>{ b.style.background = 'var(--tradesos-white)'; b.style.color='var(--tradesos-black)'; b.style.borderColor='var(--tradesos-gray-dark)'; }); }catch(_){ }
                const photosInput = document.getElementById('photos_step2'); if(photosInput) photosInput.value = '';
                const photosPreview = document.getElementById('photosPreviewStep2'); if(photosPreview) photosPreview.innerHTML = '';
            }catch(_){}
            // remove the flag so reloads won't clear again
            try{ sessionStorage.removeItem('job_clear_on_return'); }catch(_){}
        }
    }catch(_){}

    const categoryBtns = document.querySelectorAll('.category-btn');
    const urgencyBtns = document.querySelectorAll('.urgency-btn');
    const cont = document.getElementById('wizard-continue');
    let selectedCategory = {{ (selected_category or '')|tojson }};
    let selectedUrgency = {{ (urgency or '')|tojson }};
    // persist any initial selection coming from server so nav guards see it
    try{
        if(selectedCategory) sessionStorage.setItem('job_category', selectedCategory);
        if(selectedUrgency) sessionStorage.setItem('job_urgency', selectedUrgency);
    }catch(_){ }

    function updateContinueState(){
        if(!cont) return;
        // Visual-only state: leave the button clickable so validator can run and show errors
        if(selectedCategory && selectedUrgency){
            cont.style.opacity = '1';
            cont.style.cursor = 'pointer';
            cont.dataset.enabled = '1';
        } else {
            cont.style.opacity = '0.6';
            cont.style.cursor = 'pointer';
            cont.dataset.enabled = '0';
        }
    }

    function markSelectedButtons(){
        categoryBtns.forEach(b=>{
            const desc = b.querySelector('.tile-desc');
            const title = b.querySelector('.tile-title');
            if(b.dataset.category === selectedCategory){
                // selected state: rgb(198,40,40)
                b.style.background = '#C62828';
                b.style.color = '#ffffff';
                b.style.borderColor = '#C62828';
                if(title) title.style.color = '#ffffff';
                if(desc) desc.style.color = '#e9e9e9';
            } else {
                b.style.background = 'var(--tradesos-white)';
                b.style.color = 'var(--tradesos-black)';
                b.style.borderColor = 'var(--tradesos-gray-dark)';
                if(title) title.style.color = 'var(--tradesos-black)';
                if(desc) desc.style.color = 'var(--tradesos-gray-text)';
            }
        });

        urgencyBtns.forEach(b=>{
            const desc = b.querySelector('.tile-desc');
            const title = b.querySelector('strong');
            if(b.dataset.urgency === selectedUrgency){
                b.style.background = '#C62828';
                b.style.color = '#ffffff';
                b.style.borderColor = '#C62828';
                if(title) title.style.color = '#ffffff';
                if(desc) desc.style.color = '#e9e9e9';
            } else {
                b.style.background = 'var(--tradesos-white)';
                b.style.color = 'var(--tradesos-black)';
                b.style.borderColor = 'var(--tradesos-gray-dark)';
                if(title) title.style.color = 'var(--tradesos-black)';
                if(desc) desc.style.color = 'var(--tradesos-gray-text)';
            }
        });
    }

    categoryBtns.forEach(b=>{
        b.addEventListener('click', ()=>{
            selectedCategory = b.dataset.category;
            markSelectedButtons();
            updateContinueState();
            try{ sessionStorage.setItem('job_category', selectedCategory); }catch(_){ }
        });
    });

    urgencyBtns.forEach(b=>{
        b.addEventListener('click', ()=>{
            selectedUrgency = b.dataset.urgency;
            markSelectedButtons();
            updateContinueState();
            try{ sessionStorage.setItem('job_urgency', selectedUrgency); }catch(_){ }
        });
    });
    // validator for step 1 (mirrors step 2 behavior)
    window.validateStep1 = function(e){
        try{ console.debug('validateStep1 called'); }catch(_){}
        if(e){ try{ e.preventDefault(); }catch(_){}; try{ if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation(); }catch(_){}; try{ e.stopPropagation(); }catch(_){} }

        // clear previous errors
        const gen = document.getElementById('step1_general_err'); if(gen) gen.remove();
        const ec = document.getElementById('err_category'); if(ec) ec.style.display = 'none';
        const eu = document.getElementById('err_urgency'); if(eu) eu.style.display = 'none';

        let ok = true;
        if(!selectedCategory){ if(ec) ec.style.display = 'block'; ok = false; }
        if(!selectedUrgency){ if(eu) eu.style.display = 'block'; ok = false; }

        if(!ok){
            // focus first missing group
            if(!selectedCategory && categoryBtns.length) categoryBtns[0].focus();
            else if(!selectedUrgency && urgencyBtns.length) urgencyBtns[0].focus();

            // place general error below the entire controls row (not inside the flex cells)
            const controlsRow = cont ? (cont.parentNode && cont.parentNode.parentNode ? cont.parentNode.parentNode : cont.parentNode) : null;
            if(controlsRow && controlsRow.parentNode){
                const err = document.createElement('div');
                err.id = 'step1_general_err';
                err.style.color = '#b00020';
                err.style.textAlign = 'center';
                err.style.marginTop = '12px';
                err.style.width = '100%';
                err.textContent = 'Please complete the required fields before continuing';
                if(!document.getElementById('step1_general_err')) controlsRow.parentNode.insertBefore(err, controlsRow.nextSibling);
            }
            return false;
        }

        // ok -> persist and navigate to step 2
        try{ sessionStorage.setItem('job_category', selectedCategory); sessionStorage.setItem('job_urgency', selectedUrgency); }catch(_){}
        const url = new URL(window.location.href);
        url.searchParams.set('step','2');
        url.searchParams.set('category', selectedCategory);
        url.searchParams.set('urgency', selectedUrgency);
        window.location.href = url.toString();
        return true;
    };

    // attach as fallback so clicks always run validator
    if(cont) cont.addEventListener('click', validateStep1, {capture: true});

    // Back button behavior (step 2): navigate back to step 1, preserve selected category
    const backBtn = document.getElementById('wizard-back');
    if(backBtn){
        backBtn.addEventListener('click', ()=>{
            const url = new URL(window.location.href);
            url.searchParams.set('step','1');
            // preserve category selection if available
            if(selectedCategory) url.searchParams.set('category', selectedCategory);
            window.location.href = url.toString();
        });
    }

    // initial mark if values came from server
    if(selectedCategory || selectedUrgency){
        markSelectedButtons();
        updateContinueState();
    }
});
</script>
<script>
// Step 2 photos preview and validation (max 10 MB each)
document.addEventListener('DOMContentLoaded', function(){
    const photosInput = document.getElementById('photos_step2');
    const preview = document.getElementById('photosPreviewStep2');
    if(!photosInput || !preview) return;

    // keep files in an array so subsequent selections append instead of replace
    let step2Files = [];

    function renderPreview(){
        preview.innerHTML = '';
        if(step2Files.length === 0) return;

        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
        grid.style.gap = '12px';
    grid.style.margin = '0 auto';

        step2Files.forEach((file, idx) => {
            const tile = document.createElement('div');
            tile.style.position = 'relative';
            tile.style.background = 'white';
            tile.style.padding = '10px';
            tile.style.borderRadius = '6px';
            tile.style.border = '2px solid var(--tradesos-gray-dark)';
            tile.style.textAlign = 'center';
            tile.style.fontSize = '12px';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '6px';
            removeBtn.style.right = '6px';
            removeBtn.style.background = 'transparent';
            removeBtn.style.border = 'none';
            removeBtn.style.fontSize = '18px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.color = 'var(--tradesos-gray-text)';
            removeBtn.addEventListener('click', function(){
                step2Files.splice(idx,1);
                renderPreview();
            });

            if(file.type && file.type.startsWith('image/')){
                const img = document.createElement('img');
                img.style.maxWidth = '100%';
                img.style.maxHeight = '80px';
                img.style.borderRadius = '4px';
                img.style.display = 'block';
                img.style.margin = '0 auto';
                const reader = new FileReader();
                reader.onload = function(ev){ img.src = ev.target.result; };
                reader.readAsDataURL(file);
                tile.appendChild(img);
            } else {
                const icon = document.createElement('i');
                icon.className = 'fas fa-file-image';
                icon.style.fontSize = '28px';
                icon.style.color = 'var(--tradesos-red)';
                tile.appendChild(icon);
            }

            const name = document.createElement('div');
            name.textContent = file.name.length > 20 ? file.name.substring(0,20) + '...' : file.name;
            name.style.marginTop = '8px';
            name.style.color = 'var(--tradesos-black)';

            const sizeKb = Math.round(file.size / 1024);
            const sizeText = document.createElement('div');
            sizeText.textContent = `${sizeKb} KB`;
            sizeText.style.fontSize = '11px';
            sizeText.style.color = 'var(--tradesos-gray-text)';

            tile.appendChild(removeBtn);
            tile.appendChild(name);
            tile.appendChild(sizeText);
            grid.appendChild(tile);
        });

        preview.appendChild(grid);
    }

    photosInput.addEventListener('change', function(e){
        const files = Array.from(e.target.files || []);
        if(files.length === 0) return;

        const errors = [];

        files.forEach(file => {
            // validate size
            if(file.size > 10 * 1024 * 1024){
                errors.push(`${file.name} (too large)`);
                return;
            }
            // avoid duplicates by name+size
            const exists = step2Files.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
            if(exists) return;

            step2Files.push(file);
        });

        // clear input so user can re-select same file name if desired
        photosInput.value = '';

        renderPreview();

        if(errors.length){
            const errBox = document.createElement('div');
            errBox.style.color = '#b00020';
            errBox.style.marginTop = '8px';
            errBox.textContent = `Some files were not accepted: ${errors.join(', ')}`;
            preview.appendChild(errBox);
        }
    });
});
</script>
<script>
// Step 2 validation: require fields (photos are optional). Show per-field errors and a general
// message; on success navigate to step 3 and preserve category/urgency and the filled fields.
document.addEventListener('DOMContentLoaded', function(){
    const cont = document.getElementById('wizard-continue-step2');
    if(!cont) return;

    // repopulate fields from sessionStorage (in case a previous navigation cleared them)
    ['short_desc','long_desc','full_address','postcode'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        try{ const v = sessionStorage.getItem('job_'+id); if(v) el.value = v; }catch(err){}
        // persist on input
        el.addEventListener('input', function(){ try{ sessionStorage.setItem('job_'+id, this.value); }catch(err){} });
    });

    // global validator function (also wired via onclick attribute) to ensure it runs
    window.validateStep2 = function(e){
        try{ console.debug('validateStep2 called'); }catch(_){}
        if(e){
            try{ e.preventDefault(); }catch(_){}
            try{ if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation(); }catch(_){}
            try{ e.stopPropagation(); }catch(_){}
        }

        const shortEl = document.getElementById('short_desc');
        if(!shortEl) return false;

        // clear previous general error if present
        const genErr = document.getElementById('step2_general_err');
        if(genErr) genErr.remove();

        // hide field errors
        ['short_desc','long_desc','full_address','postcode'].forEach(id=>{
            const fe = document.getElementById('err_'+id);
            if(fe) fe.style.display = 'none';
        });

        let ok = true;
        const shortVal = shortEl.value.trim();
        const longVal = (document.getElementById('long_desc')||{value:''}).value.trim();
        const addrVal = (document.getElementById('full_address')||{value:''}).value.trim();
        const postVal = (document.getElementById('postcode')||{value:''}).value.trim();

        if(!shortVal){ document.getElementById('err_short_desc').style.display = 'block'; ok = false; }
        if(!longVal){ document.getElementById('err_long_desc').style.display = 'block'; ok = false; }
        if(!addrVal){ document.getElementById('err_full_address').style.display = 'block'; ok = false; }
        if(!postVal){ document.getElementById('err_postcode').style.display = 'block'; ok = false; }

        if(!ok){
            // focus first invalid field
            if(!shortVal) shortEl.focus();
            else if(!longVal) document.getElementById('long_desc').focus();
            else if(!addrVal) document.getElementById('full_address').focus();
            else if(!postVal) document.getElementById('postcode').focus();

            // show small centered general message below the controls if not present
            const controls = document.getElementById('step2-controls');
            if(controls){
                const err = document.createElement('div');
                err.id = 'step2_general_err';
                err.style.color = '#b00020';
                err.style.textAlign = 'center';
                err.style.marginTop = '12px';
                err.textContent = 'Please complete the required fields before continuing';
                // avoid adding duplicate
                if(!document.getElementById('step2_general_err')) controls.parentNode.insertBefore(err, controls.nextSibling);
            }
            return false;
        }

        // build URL to step 3 and include values as query params
        const url = new URL(window.location.href);
        url.searchParams.set('step','3');
        // preserve category & urgency from server if available
        const selectedCategory = {{ (selected_category or '')|tojson }};
        const selectedUrgency = {{ (urgency or '')|tojson }};
        if(selectedCategory) url.searchParams.set('category', selectedCategory);
        if(selectedUrgency) url.searchParams.set('urgency', selectedUrgency);
        url.searchParams.set('short_desc', shortVal);
        url.searchParams.set('long_desc', longVal);
        url.searchParams.set('full_address', addrVal);
        url.searchParams.set('postcode', postVal);

        // persist values to sessionStorage (in case navigation or other scripts run)
        try{
            sessionStorage.setItem('job_short_desc', shortVal);
            sessionStorage.setItem('job_long_desc', longVal);
            sessionStorage.setItem('job_full_address', addrVal);
            sessionStorage.setItem('job_postcode', postVal);
        }catch(err){}

        // navigate
        window.location.href = url.toString();
        return true;
    };

    // also attach as an event listener as a fallback
    cont.addEventListener('click', validateStep2, {capture: true});
});
</script>
<script>
// Align photos upload label width to the exact centerline of the Back/Continue buttons
document.addEventListener('DOMContentLoaded', function(){
    const controls = document.getElementById('step2-controls');
    const photosLabel = document.getElementById('photosLabel');
    if(!controls || !photosLabel) return;

    function alignLabel(){
        // set the photos label width to match the controls container width but not exceed 90% of viewport
        const controlsWidth = controls.offsetWidth;
        const maxAllowed = Math.min(Math.round(window.innerWidth * 0.9), 720);
        const width = Math.min(controlsWidth, maxAllowed);
        photosLabel.style.width = width + 'px';
        photosLabel.style.margin = '0 auto';
        // nudge slightly to the right relative to the controls center for visual balance on desktop,
        // compute an offset as a small fraction of controls width so it's responsive on phones
        const nudge = Math.round(Math.max(0, controlsWidth * 0.06)); // ~6% to the right
        // cap nudge to 40px on very large screens and to 6px on very small screens
        const capped = Math.min(Math.max(nudge, 6), 40);
        photosLabel.style.transform = `translateX(${capped}px)`;
        photosLabel.style.transition = 'transform 160ms ease';
    }

    // initial align and on resize
    alignLabel();
    window.addEventListener('resize', alignLabel);
    // also realign when fonts/images load (small delay)
    setTimeout(alignLabel,200);
});
</script>
<script>
// Prevent jumping ahead using the step indicator if prior steps aren't completed
document.addEventListener('DOMContentLoaded', function(){
    const stepLinks = document.querySelectorAll('.job-rim a[href*="step="]');
    if(!stepLinks || stepLinks.length === 0) return;

    function canNavigateTo(step){
        step = Number(step);
        if(isNaN(step)) return true;
        if(step <= 1) return true;
        try{
            if(step === 2){
                return !!sessionStorage.getItem('job_category') && !!sessionStorage.getItem('job_urgency');
            }
            if(step === 3 || step === 4){
                return !!sessionStorage.getItem('job_short_desc') && !!sessionStorage.getItem('job_long_desc') && !!sessionStorage.getItem('job_full_address') && !!sessionStorage.getItem('job_postcode');
            }
        }catch(e){
            return false;
        }
        return true;
    }

    function showNavErr(msg){
        const rim = document.querySelector('.job-rim');
        if(!rim) return;
        let el = document.getElementById('step_nav_err');
        if(el){ el.textContent = msg; return; }
        el = document.createElement('div');
        el.id = 'step_nav_err';
        el.style.color = '#b00020';
        el.style.textAlign = 'center';
        el.style.marginTop = '12px';
        el.style.width = '100%';
        el.textContent = msg;
        rim.parentNode.insertBefore(el, rim.nextSibling);
        setTimeout(()=>{ const e = document.getElementById('step_nav_err'); if(e) e.remove(); }, 4200);
    }

    stepLinks.forEach(a => {
        a.addEventListener('click', function(e){
            try{
                const url = new URL(a.href);
                const target = url.searchParams.get('step');
                if(!target) return;
                if(!canNavigateTo(Number(target))){
                    e.preventDefault();
                    showNavErr('Please complete the previous steps before jumping ahead.');
                }
                // additional check: if navigating to step 4, ensure step3 has at least one contact
                if(Number(target) === 4){
                    try{
                        const phone = sessionStorage.getItem('job_phone');
                        const email = sessionStorage.getItem('job_email');
                        const role = sessionStorage.getItem('job_role');
                        if(!(phone || email || role)){
                            e.preventDefault();
                            showNavErr('Please complete your contact details (step 3) before proceeding.');
                        }
                    }catch(_){ /* ignore */ }
                }
            }catch(err){ /* ignore */ }
        }, {capture: true});
    });
});
</script>
{% endblock %}