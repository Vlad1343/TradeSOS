{% extends "base_checkatrade.html" %}

{% block title %}Job Details - {{ job.title }} - TradeSOS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Job Details Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-emergency text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>{{ job.title }}
                    </h4>
                    <div>
                        {% if job.urgency == 'emergency_now' %}
                            <span class="badge bg-danger badge-lg">
                                <i class="fas fa-exclamation-circle me-1"></i>Emergency Now
                            </span>
                        {% elif job.urgency == 'urgent_2h' %}
                            <span class="badge bg-warning badge-lg">
                                <i class="fas fa-clock me-1"></i>Urgent (2h)
                            </span>
                        {% elif job.urgency == 'same_day' %}
                            <span class="badge bg-info badge-lg">
                                <i class="fas fa-calendar-day me-1"></i>Same Day
                            </span>
                        {% elif job.urgency == 'next_day' %}
                            <span class="badge bg-success badge-lg">
                                <i class="fas fa-calendar-plus me-1"></i>Next Day
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-tags me-2"></i>Category</h6>
                        <span class="badge bg-secondary fs-6">{{ job.category.title() }}</span>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                        <p class="mb-0">{{ job.postcode_full }}</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-file-alt me-2"></i>Description</h6>
                    <p class="text-muted">{{ job.description }}</p>
                </div>
                
                {% if job.get_photos() %}
                <div class="mb-3">
                    <h6><i class="fas fa-camera me-2"></i>Photos</h6>
                    <div class="row">
                        {% for photo in job.get_photos() %}
                        <div class="col-md-4 mb-2">
                            <img src="{{ photo }}" class="img-fluid rounded" alt="Job photo" 
                                 style="cursor: pointer;" onclick="openImageModal('{{ photo }}')">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-calendar me-2"></i>Created</h6>
                        <p class="mb-0">{{ job.created_at.strftime('%d/%m/%Y at %H:%M') }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Status</h6>
                        {% if job.status == 'posted' %}
                            <span class="badge bg-primary fs-6">
                                <i class="fas fa-bullhorn me-1"></i>Posted - Awaiting Trade
                            </span>
                        {% elif job.status == 'accepted' %}
                            <span class="badge bg-warning fs-6">
                                <i class="fas fa-handshake me-1"></i>Accepted by Trade
                            </span>
                        {% elif job.status == 'en_route' %}
                            <span class="badge bg-info fs-6">
                                <i class="fas fa-route me-1"></i>Trade En Route
                            </span>
                        {% elif job.status == 'in_progress' %}
                            <span class="badge bg-warning fs-6">
                                <i class="fas fa-tools me-1"></i>Work in Progress
                            </span>
                        {% elif job.status == 'completed' %}
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle me-1"></i>Completed
                            </span>
                        {% elif job.status == 'canceled' %}
                            <span class="badge bg-danger fs-6">
                                <i class="fas fa-times-circle me-1"></i>Canceled
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Information (if accepted) -->
        {% if job.accepted_trade %}
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-cog me-2"></i>Assigned Trade Professional
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5>{{ job.accepted_trade.company }}</h5>
                        {% if job.accepted_trade.get_skills() %}
                            <div class="mb-2">
                                {% for skill in job.accepted_trade.get_skills()[:5] %}
                                    <span class="badge bg-secondary me-1">{{ skill }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if job.accepted_trade.rating_avg > 0 %}
                            <div class="rating">
                                {% for i in range(1, 6) %}
                                    {% if i <= job.accepted_trade.rating_avg %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ms-1 text-muted">({{ job.accepted_trade.review_count }} reviews)</span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-md-end">
                        {% if job.accepted_trade.verified %}
                            <span class="badge bg-success mb-2">
                                <i class="fas fa-check-circle me-1"></i>Verified Professional
                            </span>
                        {% endif %}
                        {% if job.accepted_trade.plan_tier == 'premium' %}
                            <span class="badge bg-warning mb-2">
                                <i class="fas fa-crown me-1"></i>Premium Member
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if job.accepted_at %}
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Accepted on {{ job.accepted_at.strftime('%d/%m/%Y at %H:%M') }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Live Tracking (if trade en route) -->
        {% if job.status in ['accepted', 'en_route'] and job.accepted_trade %}
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-map-marked-alt me-2"></i>Live Tracking
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-route me-2"></i>
                            <strong>Trade Professional is on the way</strong>
                            <br>
                            <small class="text-muted">Live location updates will appear here when available</small>
                        </div>
                        <div class="text-end">
                            <div class="spinner-border spinner-border-sm text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mock tracking display -->
                <div id="trackingMap" class="bg-light rounded p-4 text-center">
                    <i class="fas fa-map text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">Map and ETA will be displayed here</p>
                    <small class="text-muted">Live tracking starts when the trade professional begins their journey</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status Actions -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Job Actions
                </h6>
            </div>
            <div class="card-body">
                {% if job.status == 'posted' %}
                    <div class="alert alert-primary">
                        <i class="fas fa-search me-2"></i>
                        <strong>Searching for Trades</strong>
                        <br>
                        <small>Verified trades in your area have been notified</small>
                    </div>
                {% elif job.status == 'completed' and not job.review %}
                    <a href="{{ url_for('create_review', job_id=job.id) }}" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-star me-2"></i>Leave Review
                    </a>
                {% endif %}
                
                {% if job.status in ['posted', 'accepted'] %}
                    <button class="btn btn-outline-danger w-100" onclick="confirmCancel()">
                        <i class="fas fa-times me-2"></i>Cancel Job
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="card shadow mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0">
                    <i class="fas fa-phone me-2"></i>Emergency Contacts
                </h6>
            </div>
            <div class="card-body small">
                <div class="mb-2">
                    <strong>Emergency Services:</strong> 999
                </div>
                <div class="mb-2">
                    <strong>Gas Emergency:</strong> 0800 111 999
                </div>
                <div class="mb-2">
                    <strong>Electricity Emergency:</strong> 105
                </div>
                <div class="mb-0">
                    <strong>Water Emergency:</strong> Contact your supplier
                </div>
            </div>
        </div>

        <!-- Safety Tips -->
        <div class="card shadow border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Safety Reminders
                </h6>
            </div>
            <div class="card-body small">
                <ul class="mb-0 ps-3">
                    <li>Turn off utilities if safe to do so</li>
                    <li>Keep the area clear and safe</li>
                    <li>Do not attempt repairs yourself</li>
                    <li>Ensure trade has ID and insurance</li>
                    <li>Document any additional damage</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Messaging Section (if job accepted) -->
{% if job.accepted_trade and messages is defined %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>Job Communication
                </h5>
            </div>
            <div class="card-body">
                <!-- Messages Display -->
                <div id="messageContainer" class="border rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message-bubble {{ 'sent' if message.sender_user_id == current_user.id else 'received' }} mb-2">
                            <div class="d-flex {{ 'justify-content-end' if message.sender_user_id == current_user.id else 'justify-content-start' }}">
                                <div class="message-content {{ 'bg-primary text-white' if message.sender_user_id == current_user.id else 'bg-light' }} p-2 rounded" style="max-width: 70%;">
                                    <p class="mb-1">{{ message.text }}</p>
                                    <small class="text-muted {{ 'text-white-50' if message.sender_user_id == current_user.id else '' }}">
                                        {{ message.created_at.strftime('%H:%M') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">No messages yet. Start the conversation!</p>
                    {% endif %}
                </div>
                
                <!-- Message Form -->
                <form method="POST" action="{{ url_for('send_message', job_id=job.id) }}">
                    <div class="input-group">
                        <input type="text" name="message" class="form-control" placeholder="Type your message..." required maxlength="500">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Messages are only visible to you, the assigned trade professional, and TradeSOS support if needed.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Job Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Job photo">
            </div>
        </div>
    </div>
</div>

<script>
function openImageModal(imageUrl) {
    document.getElementById('modalImage').src = imageUrl;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function confirmCancel() {
    if (confirm('Are you sure you want to cancel this job? This action cannot be undone.')) {
        // In a real app, this would submit a cancel request
        alert('Job cancellation would be processed here');
    }
}

// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('messageContainer');
    if (messageContainer) {
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }
});
</script>
{% endblock %}
