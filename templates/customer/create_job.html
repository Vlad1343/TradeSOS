{% extends "base.html" %}

{% block title %}Create Emergency Job - TradeSOS{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-emergency text-white">
                <h3 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Create Emergency Job Request
                </h3>
                <p class="mb-0 mt-2">Provide as much detail as possible to help trades assess your emergency</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <!-- Urgency Level - Most Important -->
                    <div class="alert alert-warning mb-4">
                        <h6><i class="fas fa-clock me-2"></i>How urgent is this?</h6>
                        <div class="row">
                            <div class="col-md-6 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="urgency" id="emergency_now" value="emergency_now">
                                    <label class="form-check-label text-danger fw-bold" for="emergency_now">
                                        <i class="fas fa-exclamation-circle me-1"></i>Emergency Now
                                        <br><small>Immediate response needed</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="urgency" id="urgent_2h" value="urgent_2h">
                                    <label class="form-check-label text-warning fw-bold" for="urgent_2h">
                                        <i class="fas fa-clock me-1"></i>Urgent (2h)
                                        <br><small>Within 2 hours</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="urgency" id="same_day" value="same_day">
                                    <label class="form-check-label text-info fw-bold" for="same_day">
                                        <i class="fas fa-calendar-day me-1"></i>Same Day
                                        <br><small>Within 8 hours</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="urgency" id="next_day" value="next_day">
                                    <label class="form-check-label text-success fw-bold" for="next_day">
                                        <i class="fas fa-calendar-plus me-1"></i>Next Day
                                        <br><small>Within 24 hours</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% if form.urgency.errors %}
                            <div class="text-danger small mt-2">
                                {% for error in form.urgency.errors %}
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            {{ form.title.label(class="form-label fw-bold") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="e.g., Burst pipe flooding kitchen") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.category.label(class="form-label fw-bold") }}
                            {{ form.category(class="form-select form-select-lg" + (" is-invalid" if form.category.errors else "")) }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label fw-bold") }}
                        <small class="text-muted">(Include what happened, what's affected, and any immediate steps you've taken)</small>
                        {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), placeholder="Describe the problem in detail: What happened? What's not working? Any immediate damage or safety concerns?") }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <span id="charCount">0</span> / 1000 characters
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.postcode.label(class="form-label fw-bold") }}
                        <small class="text-muted">(UK postcode format: e.g., M1 1AA)</small>
                        {{ form.postcode(class="form-control form-control-lg" + (" is-invalid" if form.postcode.errors else ""), placeholder="M1 1AA", style="text-transform: uppercase;") }}
                        {% if form.postcode.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.postcode.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        {{ form.photos.label(class="form-label fw-bold") }}
                        <small class="text-muted">(Help trades assess the situation - max 16MB per file)</small>
                        {{ form.photos(class="form-control", accept="image/*", multiple=true) }}
                        {% if form.photos.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.photos.errors %}
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-camera me-1"></i>
                            Photos help trades understand the problem and bring the right tools.
                        </div>
                    </div>
                    
                    <!-- Safety Notice -->
                    <div class="alert alert-danger mb-4">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Safety Notice</h6>
                        <ul class="mb-0 small">
                            <li><strong>Immediate danger:</strong> Call 999 if there's risk to life or property</li>
                            <li><strong>Gas leaks:</strong> Call National Gas Emergency: 0800 111 999</li>
                            <li><strong>Electrical hazards:</strong> Turn off power at the mains if safe to do so</li>
                            <li><strong>Water damage:</strong> Turn off water supply to prevent further damage</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-emergency btn-lg") }}
                    </div>
                    
                    <div class="alert alert-info mt-3 small">
                        <i class="fas fa-info-circle me-2"></i>
                        After submitting, verified trades in your area will be notified immediately. 
                        The first trade to accept your job will contact you directly.
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counter for description
    const descriptionField = document.getElementById('description');
    const charCount = document.getElementById('charCount');
    
    if (descriptionField && charCount) {
        function updateCharCount() {
            const count = descriptionField.value.length;
            charCount.textContent = count;
            charCount.className = count > 800 ? 'text-warning' : count > 950 ? 'text-danger' : '';
        }
        
        descriptionField.addEventListener('input', updateCharCount);
        updateCharCount(); // Initialize
    }
    
    // Auto-uppercase postcode
    const postcodeField = document.getElementById('postcode');
    if (postcodeField) {
        postcodeField.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    // Preview uploaded images
    const photosField = document.getElementById('photos');
    if (photosField) {
        photosField.addEventListener('change', function() {
            const files = this.files;
            let previewHtml = '';
            
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    previewHtml += `<small class="text-muted me-3"><i class="fas fa-image me-1"></i>${file.name}</small>`;
                }
            }
            
            if (files.length > 5) {
                previewHtml += `<small class="text-warning">+${files.length - 5} more files</small>`;
            }
            
            // Add preview container if it doesn't exist
            let previewContainer = document.getElementById('photoPreview');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'photoPreview';
                previewContainer.className = 'mt-2';
                photosField.parentNode.appendChild(previewContainer);
            }
            
            previewContainer.innerHTML = previewHtml;
        });
    }
});
</script>
{% endblock %}
