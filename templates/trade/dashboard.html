{% extends "base.html" %}

{% block title %}Trade Dashboard - TradeSOS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>Trade Professional Dashboard</h1>
        <p class="text-muted">Welcome back, {{ trade.company }}!</p>
    </div>
</div>

<!-- Status Overview -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h5>Verification Status</h5>
                <p class="mb-0">
                    {% if trade.verified %}
                        <i class="fas fa-check me-1"></i>Verified
                    {% else %}
                        <i class="fas fa-clock me-1"></i>Pending
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card {{ 'bg-warning' if trade.plan_tier == 'premium' else 'bg-secondary' }} text-white">
            <div class="card-body text-center">
                <i class="fas {{ 'fa-crown' if trade.plan_tier == 'premium' else 'fa-user' }} fa-2x mb-2"></i>
                <h5>Subscription</h5>
                <p class="mb-0">{{ trade.plan_tier.title() }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-star fa-2x mb-2"></i>
                <h5>Rating</h5>
                <p class="mb-0">
                    {% if trade.rating_avg > 0 %}
                        {{ "%.1f"|format(trade.rating_avg) }} / 5.0
                    {% else %}
                        No reviews yet
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                <h5>Completed Jobs</h5>
                <p class="mb-0">{{ accepted_jobs|selectattr('status', 'equalto', 'completed')|list|length }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Verification Alert -->
{% if not trade.verified %}
<div class="alert alert-warning mb-4">
    <h6><i class="fas fa-exclamation-triangle me-2"></i>Account Verification Required</h6>
    <p class="mb-2">Your account is pending verification. Complete your profile and upload required documents to start receiving job notifications.</p>
    <a href="{{ url_for('trade_profile') }}" class="btn btn-warning">
        <i class="fas fa-user-cog me-1"></i>Complete Profile
    </a>
</div>
{% endif %}

<!-- Premium Promotion -->
{% if trade.plan_tier == 'standard' %}
<div class="alert alert-info mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h6><i class="fas fa-crown me-2"></i>Upgrade to Premium</h6>
            <p class="mb-0">Get first access to new jobs and priority ranking for just £80/month.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{{ url_for('upgrade_to_premium') }}" class="btn btn-warning">
                <i class="fas fa-arrow-up me-1"></i>Upgrade Now
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Available Jobs -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>Available Jobs
                    {% if trade.plan_tier == 'premium' %}
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="fas fa-crown me-1"></i>Premium First Access
                        </span>
                    {% endif %}
                </h5>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshJobs()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                {% if available_jobs %}
                    <div id="jobsList">
                        {% for job in available_jobs %}
                        <div class="job-card border rounded p-3 mb-3 {{ 'border-warning' if job.urgency == 'emergency_now' else 'border-light' }}">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-3">{{ job.title }}</h6>
                                        {% if job.urgency == 'emergency_now' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-circle me-1"></i>Emergency Now
                                            </span>
                                        {% elif job.urgency == 'urgent_2h' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Urgent (2h)
                                            </span>
                                        {% elif job.urgency == 'same_day' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-calendar-day me-1"></i>Same Day
                                            </span>
                                        {% elif job.urgency == 'next_day' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-calendar-plus me-1"></i>Next Day
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <p class="text-muted mb-2">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ job.postcode_full }} • 
                                        <i class="fas fa-tags me-1"></i>{{ job.category.title() }} •
                                        <i class="fas fa-clock me-1"></i>{{ job.created_at.strftime('%H:%M') }}
                                    </p>
                                    
                                    <p class="mb-0 small">{{ job.description[:100] }}{% if job.description|length > 100 %}...{% endif %}</p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    {% if job.get_photos() %}
                                        <div class="mb-2">
                                            <i class="fas fa-camera text-muted me-1"></i>
                                            <small class="text-muted">{{ job.get_photos()|length }} photo(s)</small>
                                        </div>
                                    {% endif %}
                                    
                                    <form method="POST" action="{{ url_for('accept_job', job_id=job.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-success" onclick="return confirmAccept('{{ job.title }}')">
                                            <i class="fas fa-handshake me-1"></i>Accept Job
                                        </button>
                                    </form>
                                    
                                    <div class="mt-2">
                                        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No available jobs</h5>
                        {% if not trade.verified %}
                            <p class="text-muted">Complete your verification to start receiving job notifications.</p>
                        {% elif not trade.get_coverage_areas() and not trade.get_coverage_districts() %}
                            <p class="text-muted">Set up your coverage areas to receive relevant job notifications.</p>
                            <a href="{{ url_for('trade_profile') }}" class="btn btn-primary">
                                <i class="fas fa-map-marked-alt me-1"></i>Set Coverage Areas
                            </a>
                        {% else %}
                            <p class="text-muted">No jobs in your coverage areas at the moment. Check back soon!</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('trade_profile') }}" class="btn btn-outline-primary">
                        <i class="fas fa-user-cog me-2"></i>Update Profile
                    </a>
                    <a href="{{ url_for('trade_billing') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-credit-card me-2"></i>Billing & Plans
                    </a>
                    {% if trade.plan_tier == 'standard' %}
                        <a href="{{ url_for('upgrade_to_premium') }}" class="btn btn-warning">
                            <i class="fas fa-crown me-2"></i>Upgrade to Premium
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Coverage Areas -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-map-marked-alt me-2"></i>Coverage Areas
                </h6>
            </div>
            <div class="card-body">
                {% if trade.get_coverage_areas() or trade.get_coverage_districts() %}
                    {% if trade.get_coverage_areas() %}
                        <div class="mb-2">
                            <strong>Areas:</strong>
                            {% for area in trade.get_coverage_areas() %}
                                <span class="badge bg-primary me-1">{{ area }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if trade.get_coverage_districts() %}
                        <div>
                            <strong>Districts:</strong>
                            {% for district in trade.get_coverage_districts() %}
                                <span class="badge bg-secondary me-1">{{ district }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted mb-2">No coverage areas set</p>
                    <a href="{{ url_for('trade_profile') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Add Coverage
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Skills -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Skills & Services
                </h6>
            </div>
            <div class="card-body">
                {% if trade.get_skills() %}
                    {% for skill in trade.get_skills() %}
                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-2">No skills listed</p>
                    <a href="{{ url_for('trade_profile') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Add Skills
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Accepted Jobs -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>My Recent Jobs
                </h5>
            </div>
            <div class="card-body">
                {% if accepted_jobs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Accepted</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in accepted_jobs %}
                                <tr>
                                    <td>
                                        <strong>{{ job.title }}</strong><br>
                                        <small class="text-muted">{{ job.postcode_full }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ job.category.title() }}</span>
                                    </td>
                                    <td>
                                        {% if job.status == 'accepted' %}
                                            <span class="badge bg-warning">Accepted</span>
                                        {% elif job.status == 'en_route' %}
                                            <span class="badge bg-info">En Route</span>
                                        {% elif job.status == 'in_progress' %}
                                            <span class="badge bg-primary">In Progress</span>
                                        {% elif job.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif job.status == 'canceled' %}
                                            <span class="badge bg-danger">Canceled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ job.accepted_at.strftime('%d/%m/%Y %H:%M') if job.accepted_at else '-' }}</small>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No jobs accepted yet</h5>
                        <p class="text-muted">Start accepting jobs to build your reputation and reviews.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function confirmAccept(jobTitle) {
    return confirm(`Are you sure you want to accept the job: "${jobTitle}"?\n\nOnce accepted, you will be responsible for completing this emergency job.`);
}

function refreshJobs() {
    // In a real app, this would refresh the jobs list via AJAX
    location.reload();
}

// Auto-refresh jobs every 30 seconds
setInterval(function() {
    // In a real app, this would update the jobs list without full page reload
    console.log('Auto-refreshing jobs...');
}, 30000);
</script>
{% endblock %}
