{% extends "base_checkatrade.html" %}

{% block title %}Register - TradeSOS{% endblock %}

{% block content %}
<div style="background-color: var(--tradesos-gray); min-height: 100vh; padding: 40px 20px;">
    <div class="tradesos-form" style="max-width: 800px;">
        <div style="text-align: center; margin-bottom: 40px;">
            <i class="fas fa-user-plus" style="font-size: 48px; color: var(--tradesos-red); margin-bottom: 20px;"></i>
            <h2>JOIN TRADESOS</h2>
            <p class="tradesos-info" style="color: var(--tradesos-gray-text); font-size: 14px; margin: 10px 0 0 0;">
                Connect with emergency trade services across the UK
            </p>
        </div>
        <style>
            /* Role-selection layout only: ensure role cards match size without affecting other .grid-2 uses */
            .role-selection { display: flex; gap: 16px; align-items: stretch; }
            .role-selection > div { flex: 1; display: flex; }
            .role-card {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%; /* fill parent column */
                min-height: 160px;
                box-sizing: border-box;
            }
            /* Normalize inner heading/p spacing so both cards match exactly */
            .role-card h4 { margin: 10px 0 5px 0; }
            .role-card p { margin: 0; }
        </style>
        
        <form method="POST" action="{{ url_for('register') }}" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            
            <!-- Role Selection -->
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom: 25px;">
                    <i class="fas fa-users" style="margin-right: 10px;"></i>I AM A
                </h3>
                <div class="grid-2 role-selection">
                    <div>
                    <div class="role-card" data-role="customer" style="background-color: var(--tradesos-white); padding: 25px; border-radius: 4px; border: 2px solid var(--tradesos-gray-dark); cursor: pointer; transition: all 0.3s ease;">
                            <div style="text-align: center;">
                                <i class="fas fa-home" style="font-size: 24px; color: var(--tradesos-red); margin-bottom: 10px;"></i>
                                <h4 style="margin: 10px 0 5px 0; color: var(--tradesos-black);">CUSTOMER</h4>
                                <p style="margin: 0; color: var(--tradesos-gray-text); font-size: 12px;">I need emergency trade services</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="role-card" data-role="trade" style="background-color: var(--tradesos-white); padding: 25px; border-radius: 4px; border: 2px solid var(--tradesos-gray-dark); cursor: pointer; transition: all 0.3s ease;">
                            <div style="text-align: center;">
                                <i class="fas fa-tools" style="font-size: 24px; color: var(--tradesos-red); margin-bottom: 10px;"></i>
                                <h4 style="margin: 10px 0 5px 0; color: var(--tradesos-black);">TRADE PROFESSIONAL</h4>
                                <p style="margin: 0; color: var(--tradesos-gray-text); font-size: 12px;">I provide emergency trade services</p>
                            </div>
                        </div>
                    </div>
                </div>
                {{ form.role(id='role', style="display: none;") }}
                {% if form.role.errors %}
                    <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 10px;">
                        {% for error in form.role.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Basic Information -->
            <div class="grid-2">
                <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(id='email', class="form-control" + (" error" if form.email.errors else "")) }}
                    {% if form.email.errors %}
                        <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                            {% for error in form.email.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    {{ form.name.label(class="form-label") }}
                    <div class="tradesos-info" id="nameHelp" style="margin-bottom: 5px;"></div>
                    {{ form.name(id='name', class="form-control" + (" error" if form.name.errors else "")) }}
                    {% if form.name.errors %}
                        <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                            {% for error in form.name.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(id='password', class="form-control" + (" error" if form.password.errors else "")) }}
                    {% if form.password.errors %}
                        <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                            {% for error in form.password.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="tradesos-info">Must be at least 8 characters long</div>
                </div>
                
                <div class="form-group">
                    {{ form.password2.label(class="form-label") }}
                    {{ form.password2(id='password2', class="form-control" + (" error" if form.password2.errors else "")) }}
                    {% if form.password2.errors %}
                        <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                            {% for error in form.password2.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                {{ form.phone.label(class="form-label") }}
                {{ form.phone(id='phone', class="form-control" + (" error" if form.phone.errors else "")) }}
                {% if form.phone.errors %}
                    <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                        {% for error in form.phone.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Trade Professional Fields -->
            <div id="trade-fields" style="display: none;">
                    <div style="margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-left: 4px solid var(--tradesos-red);">
                    <h4 style="margin: 0 0 15px 0; color: var(--tradesos-red);">
                        <i class="fas fa-hard-hat"></i> Trade Professional Information
                    </h4>
                    <p style="margin: 0; font-size: 14px; color: var(--tradesos-gray-text);">Complete these fields to verify your trade credentials and begin receiving emergency callouts</p>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        {{ form.companies_house_number.label(class="form-label") }}
                        {{ form.companies_house_number(id='companies_house_number', class="form-control" + (" error" if form.companies_house_number.errors else "")) }}
                        {% if form.companies_house_number.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.companies_house_number.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.vat_number.label(class="form-label") }}
                        {{ form.vat_number(id='vat_number', class="form-control" + (" error" if form.vat_number.errors else "")) }}
                        {% if form.vat_number.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.vat_number.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        {{ form.skills.label(class="form-label") }}
                        {{ form.skills(id='skills', class="form-control" + (" error" if form.skills.errors else "")) }}
                        {% if form.skills.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.skills.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.coverage_areas.label(class="form-label") }}
                        {{ form.coverage_areas(id='coverage_areas', class="form-control" + (" error" if form.coverage_areas.errors else "")) }}
                        {% if form.coverage_areas.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.coverage_areas.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Document Upload Section -->
                <div style="margin: 25px 0; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                    <h5 style="margin: 0 0 15px 0; color: #d63031;">
                        <i class="fas fa-file-upload"></i> Professional Documents
                    </h5>
                    <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--tradesos-gray-text);">Upload your trade credentials to verify your professional status and begin accepting emergency callouts</p>
                    
                    <div class="form-group">
                        {{ form.insurance_document.label(class="form-label") }}
                        {{ form.insurance_document(id='insurance_document', class="form-control file-input" + (" error" if form.insurance_document.errors else "")) }}
                        {% if form.insurance_document.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.insurance_document.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div style="font-size: 12px; color: var(--tradesos-gray-text); margin-top: 5px;">
                            <i class="fas fa-shield-alt" style="margin-right: 5px;"></i>
                            Upload your current public liability insurance certificate (Required)
                        </div>
                        <div id="insurance_preview" class="file-previews" style="margin-top:8px"></div>
                    </div>
                    
                    <div class="form-group">
                        {{ form.qualification_documents.label(class="form-label") }}
                        {{ form.qualification_documents(id='qualification_documents', class="form-control file-input" + (" error" if form.qualification_documents.errors else ""), multiple=True) }}
                        {% if form.qualification_documents.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.qualification_documents.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div style="font-size: 12px; color: var(--tradesos-gray-text); margin-top: 5px;">
                            <i class="fas fa-certificate" style="margin-right: 5px;"></i>
                            Upload your trade qualifications, certifications, and professional credentials
                        </div>
                        <div id="qualification_preview" class="file-previews" style="margin-top:8px"></div>
                    </div>
                    
                    <div class="form-group">
                        {{ form.gas_safe_certificate.label(class="form-label") }}
                        {{ form.gas_safe_certificate(id='gas_safe_certificate', class="form-control file-input" + (" error" if form.gas_safe_certificate.errors else "")) }}
                        {% if form.gas_safe_certificate.errors %}
                            <div style="color: var(--tradesos-red); font-size: 12px; margin-top: 5px;">
                                {% for error in form.gas_safe_certificate.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div style="font-size: 12px; color: var(--tradesos-gray-text); margin-top: 5px;">
                            <i class="fas fa-fire" style="margin-right: 5px;"></i>
                            Required only if you work with gas appliances or installations
                        </div>
                        <div id="gas_preview" class="file-previews" style="margin-top:8px"></div>
                    </div>
                </div>
            </div>
            
            {{ form.submit(class="tradesos-btn tradesos-btn-primary tradesos-btn-block", style="padding: 20px; font-size: 16px; margin-bottom: 25px;") }}
            
            <div style="background-color: #F8F9FA; padding: 20px; border-radius: 4px; margin-bottom: 25px;">
                <div style="font-size: 12px; color: var(--tradesos-gray-text); line-height: 1.5;">
                    <i class="fas fa-info-circle" style="margin-right: 5px; color: var(--tradesos-red);"></i>
                    By registering, you agree to our terms of service and privacy policy. 
                    All trade professionals must be verified before accepting jobs
                </div>
            </div>
        </form>
        
        <div style="text-align: center; padding-top: 20px; border-top: 1px solid var(--tradesos-gray-dark);">
            <p style="margin: 0; color: #666; font-size: 14px;">
                Already have an account? 
                <a href="{{ url_for('login') }}" style="color: var(--tradesos-red); text-decoration: none; font-weight: 700;">Log in here</a>
            </p>
        </div>
    </div>
</div>

<script>
    // Role selection and field management
    function selectRole(role) {
        document.querySelectorAll('.role-card').forEach(card => {
            card.style.borderColor = 'var(--tradesos-gray-dark)';
        });
        const selectedCard = document.querySelector(`.role-card[data-role="${role}"]`);
        if (selectedCard) selectedCard.style.borderColor = 'var(--tradesos-red)';
        if (document.getElementById('role')) document.getElementById('role').value = role;
        updateFieldsForRole(role);
    }

    function updateFieldsForRole(role) {
        const tradeFields = document.getElementById('trade-fields');
        if (!tradeFields) return;
        if (role === 'customer') {
            // don't show trade fields for customers
            tradeFields.style.display = 'none';
        } else if (role === 'trade') {
            // show trade-specific fields for professionals
            tradeFields.style.display = 'block';
        }
    }

    // --- File upload helpers: cumulative multi-upload, previews, and delete ---
    const fileStores = new Map(); // Map<inputElement, DataTransfer>

    function renderPreviewsForInput(inputEl, previewId) {
        const preview = document.getElementById(previewId);
        if (!preview) return;
        preview.innerHTML = '';
        const files = inputEl.files;
        if (!files || files.length === 0) return;
        Array.from(files).forEach((file, idx) => {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.style.display = 'flex';
            item.style.alignItems = 'center';
            item.style.justifyContent = 'space-between';
            item.style.padding = '6px 8px';
            item.style.border = '1px solid #eee';
            item.style.borderRadius = '4px';
            item.style.marginBottom = '6px';

            const left = document.createElement('div');
            left.style.display = 'flex';
            left.style.alignItems = 'center';

            const name = document.createElement('span');
            name.textContent = file.name;
            name.style.marginRight = '8px';

            const meta = document.createElement('small');
            meta.style.color = '#666';
            meta.textContent = ` (${Math.round(file.size/1024)} KB)`;

            left.appendChild(name);
            left.appendChild(meta);

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'file-remove';
            del.textContent = 'Remove';
            del.style.color = 'var(--tradesos-red)';
            del.style.background = 'none';
            del.style.border = 'none';
            del.style.cursor = 'pointer';
            del.style.padding = '0';

            del.addEventListener('click', function() {
                removeFileAtIndex(inputEl, idx);
            });

            item.appendChild(left);
            item.appendChild(del);
            preview.appendChild(item);
        });
    }

    function removeFileAtIndex(inputEl, index) {
        const store = fileStores.get(inputEl);
        if (!store) {
            // fallback: clear input entirely
            inputEl.value = '';
            const previewId = inputEl.id === 'qualification_documents' ? 'qualification_preview' : (inputEl.id === 'insurance_document' ? 'insurance_preview' : 'gas_preview');
            const p = document.getElementById(previewId);
            if (p) p.innerHTML = '';
            return;
        }
        const newDt = new DataTransfer();
        Array.from(store.files).forEach((f, i) => {
            if (i !== index) newDt.items.add(f);
        });
        fileStores.set(inputEl, newDt);
        inputEl.files = newDt.files;
        const previewId = inputEl.id === 'qualification_documents' ? 'qualification_preview' : (inputEl.id === 'insurance_document' ? 'insurance_preview' : 'gas_preview');
        renderPreviewsForInput(inputEl, previewId);
    }

    function handleFileInputChange(e) {
        const input = e.target;
        // incoming files from the most recent selection
        const incoming = Array.from(input.files || []);
        let dt = fileStores.get(input);
        if (!dt) dt = new DataTransfer();
        incoming.forEach(f => {
            const duplicate = Array.from(dt.files).some(existing => existing.name === f.name && existing.size === f.size && existing.type === f.type);
            if (!duplicate) dt.items.add(f);
        });
        fileStores.set(input, dt);
        input.files = dt.files;
        const previewId = input.id === 'qualification_documents' ? 'qualification_preview' : (input.id === 'insurance_document' ? 'insurance_preview' : 'gas_preview');
        renderPreviewsForInput(input, previewId);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers to role cards
        document.querySelectorAll('.role-card').forEach(card => {
            card.addEventListener('click', function() {
                const role = this.getAttribute('data-role');
                selectRole(role);
            });
        });

        // Determine initial role: prefer URL param ?role=trade or the hidden form value, fallback to customer
        const params = new URLSearchParams(window.location.search);
        let initialRole = params.get('role') || (document.getElementById('role') && document.getElementById('role').value) || 'customer';
        if (initialRole !== 'trade' && initialRole !== 'customer') {
            initialRole = 'customer';
        }

        // Initialize selected role
        selectRole(initialRole);

        // Attach file input handlers (cumulative add + preview + delete)
        document.querySelectorAll('.file-input').forEach(inp => {
            // ensure input id exists so we can map previews
            if (!inp.id) return;
            inp.addEventListener('change', handleFileInputChange);
            // if browser restored files (unlikely), initialize store
            if (inp.files && inp.files.length) {
                const dt = new DataTransfer();
                Array.from(inp.files).forEach(f => dt.items.add(f));
                fileStores.set(inp, dt);
                const previewId = inp.id === 'qualification_documents' ? 'qualification_preview' : (inp.id === 'insurance_document' ? 'insurance_preview' : 'gas_preview');
                renderPreviewsForInput(inp, previewId);
            }
        });

        // --- Client-side form validation ---
        const formEl = document.querySelector('form[method="POST"]');
        function clearErrors() {
            document.querySelectorAll('.client-error').forEach(e => e.remove());
        }
        function showFieldError(inputEl, message) {
            const err = document.createElement('div');
            err.className = 'client-error';
            err.style.color = 'var(--tradesos-red)';
            err.style.fontSize = '12px';
            err.style.marginTop = '6px';
            err.textContent = message;
            // try to place after the input or after the input's container
            if (inputEl && inputEl.parentNode) inputEl.parentNode.appendChild(err);
            else formEl.insertBefore(err, formEl.firstChild);
        }

        function validateForm(e) {
            clearErrors();
            let valid = true;
            const role = (document.getElementById('role') && document.getElementById('role').value) || 'customer';

            // Basic common checks (email/name/password)
            const email = document.getElementById('email');
            const name = document.getElementById('name');
            const password = document.getElementById('password');
            const password2 = document.getElementById('password2');
            if (email && !email.value.trim()) { showFieldError(email, 'Email is required.'); valid = false; }
            if (name && !name.value.trim()) { showFieldError(name, 'Name is required.'); valid = false; }
            if (password) {
                if (!password.value || password.value.length < 8) { showFieldError(password, 'Password must be at least 8 characters.'); valid = false; }
                if (password2 && password.value !== password2.value) { showFieldError(password2, 'Passwords do not match.'); valid = false; }
            }

            if (role === 'trade') {
                // required trade fields: vat_number, skills, coverage_areas, insurance_document
                const vat = document.getElementById('vat_number');
                const companiesHouse = document.getElementById('companies_house_number');
                const skills = document.getElementById('skills');
                const coverage = document.getElementById('coverage_areas');
                const insuranceInput = document.getElementById('insurance_document');
                const qualificationInput = document.getElementById('qualification_documents');
                if (vat && !vat.value.trim()) { showFieldError(vat, 'VAT number is required'); valid = false; }
                if (companiesHouse && !companiesHouse.value.trim()) { showFieldError(companiesHouse, 'Companies House number is required'); valid = false; }
                if (skills && !skills.value.trim()) { showFieldError(skills, 'Please list at least one skill.'); valid = false; }
                if (coverage && !coverage.value.trim()) { showFieldError(coverage, 'Coverage areas are required'); valid = false; }
                // insurance: check input.files or fileStores
                let hasInsurance = false;
                if (insuranceInput) {
                    if ((insuranceInput.files && insuranceInput.files.length > 0)) hasInsurance = true;
                    else {
                        const store = fileStores.get(insuranceInput);
                        if (store && store.files && store.files.length > 0) hasInsurance = true;
                    }
                }
                if (!hasInsurance) { if (insuranceInput) showFieldError(insuranceInput, 'Please upload your public liability insurance certificate'); valid = false; }
                // qualifications: check input.files or fileStores
                let hasQualifications = false;
                if (qualificationInput) {
                    if ((qualificationInput.files && qualificationInput.files.length > 0)) hasQualifications = true;
                    else {
                        const storeQ = fileStores.get(qualificationInput);
                        if (storeQ && storeQ.files && storeQ.files.length > 0) hasQualifications = true;
                    }
                }
                if (!hasQualifications) { if (qualificationInput) showFieldError(qualificationInput, 'Please upload at least one qualification or certification document'); valid = false; }
            }

            if (!valid) {
                e.preventDefault();
                // scroll to first error
                const first = document.querySelector('.client-error');
                if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        if (formEl) formEl.addEventListener('submit', validateForm);
    });
</script>

{% endblock %}