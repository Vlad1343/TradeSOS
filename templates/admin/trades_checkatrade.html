{% extends "main/base_checkatrade.html" %}

{% block content %}
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1 class="admin-title">Trade Management</h1>
        <p class="admin-subtitle">Review and verify trade professional applications</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid" style="margin-bottom: 40px;">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number">{{ trades.total }}</div>
            <div class="stat-label">Total Applications</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="stat-number">{{ trades.items | selectattr('verified', 'equalto', true) | list | length }}</div>
            <div class="stat-label">Verified Trades</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-number">{{ trades.items | selectattr('verified', 'equalto', false) | list | length }}</div>
            <div class="stat-label">Pending Review</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-number">{{ ((trades.items | selectattr('verified', 'equalto', true) | list | length / trades.total * 100) | round(1)) if trades.total > 0 else 0 }}%</div>
            <div class="stat-label">Approval Rate</div>
        </div>
    </div>

    <!-- Trade Applications -->
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title-small">Trade Applications</h2>
            <div style="display: flex; gap: 12px;">
                <select onchange="filterTrades(this.value)" style="padding: 8px 12px; border: 2px solid var(--tradesos-gray-dark); border-radius: var(--border-radius); background: white;">
                    <option value="">All Applications</option>
                    <option value="verified">Verified Only</option>
                    <option value="pending">Pending Review</option>
                </select>
            </div>
        </div>
        
        {% if trades.items %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;" id="tradesTable">
                <thead>
                    <tr style="border-bottom: 2px solid var(--tradesos-gray-dark);">
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Company Details</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Contact</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Registration</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Skills & Coverage</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Documents</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Status</th>
                        <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--tradesos-black);">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades.items %}
                    <tr class="trade-row" data-verified="{{ trade.verified|lower }}" style="border-bottom: 1px solid var(--tradesos-gray-dark);">
                        <td style="padding: 16px 12px;">
                            <div>
                                <div style="font-weight: 600; color: var(--tradesos-black); margin-bottom: 4px;">{{ trade.company }}</div>
                                <div style="font-size: 14px; color: var(--tradesos-gray-text);">Applied {{ trade.created_at.strftime('%d %b %Y') }}</div>
                            </div>
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            <div style="font-size: 14px;">
                                <div style="margin-bottom: 4px;">
                                    <i class="fas fa-envelope" style="color: var(--tradesos-red); margin-right: 6px; width: 12px;"></i>
                                    {{ trade.user.email if trade.user else 'No email' }}
                                </div>
                                {% if trade.phone %}
                                <div>
                                    <i class="fas fa-phone" style="color: var(--tradesos-red); margin-right: 6px; width: 12px;"></i>
                                    {{ trade.phone }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            <div style="font-size: 14px;">
                                {% if trade.companies_house_number %}
                                <div style="margin-bottom: 4px;">
                                    <strong>CH:</strong> {{ trade.companies_house_number }}
                                </div>
                                {% endif %}
                                {% if trade.vat_number %}
                                <div style="margin-bottom: 4px;">
                                    <strong>VAT:</strong> {{ trade.vat_number }}
                                </div>
                                {% endif %}
                                {% if trade.utr_number %}
                                <div>
                                    <strong>UTR:</strong> {{ trade.utr_number }}
                                </div>
                                {% endif %}
                                {% if not trade.companies_house_number and not trade.vat_number and not trade.utr_number %}
                                <span style="color: var(--tradesos-gray-text); font-style: italic;">No registration details</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            <div style="font-size: 14px;">
                                {% set skills = trade.get_skills() %}
                                {% if skills %}
                                <div style="margin-bottom: 8px;">
                                    {% for skill in skills[:3] %}
                                    <span style="background: var(--tradesos-gray); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;">{{ skill }}</span>
                                    {% endfor %}
                                    {% if skills|length > 3 %}
                                    <span style="color: var(--tradesos-gray-text); font-size: 11px;">+{{ skills|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                {% set areas = trade.get_coverage_areas() %}
                                {% if areas %}
                                <div style="font-size: 12px; color: var(--tradesos-gray-text);">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 4px;"></i>
                                    {{ areas[:2]|join(', ') }}{% if areas|length > 2 %} +{{ areas|length - 2 }}{% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            <div style="font-size: 14px;">
                                {% if trade.insurance_document_url %}
                                <div style="margin-bottom: 4px;">
                                    <a href="{{ url_for('view_document', path=trade.insurance_document_url) }}" target="_blank" style="color: var(--tradesos-red); text-decoration: none;">
                                        <i class="fas fa-file-pdf" style="margin-right: 4px;"></i>Insurance
                                    </a>
                                </div>
                                {% endif %}
                                {% if trade.gas_safe_certificate_url %}
                                <div>
                                    <a href="{{ url_for('view_document', path=trade.gas_safe_certificate_url) }}" target="_blank" style="color: var(--tradesos-red); text-decoration: none;">
                                        <i class="fas fa-file-pdf" style="margin-right: 4px;"></i>Gas Safe
                                    </a>
                                </div>
                                {% endif %}
                                {% if not trade.insurance_document_url and not trade.gas_safe_certificate_url %}
                                <span style="color: var(--tradesos-gray-text); font-style: italic;">No documents</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            {% if trade.verified %}
                                <span style="background: #28a745; color: white; padding: 6px 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: 500;">
                                    <i class="fas fa-check" style="margin-right: 6px;"></i>Verified
                                </span>
                            {% else %}
                                <span style="background: #ffc107; color: black; padding: 6px 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: 500;">
                                    <i class="fas fa-clock" style="margin-right: 6px;"></i>Pending
                                </span>
                            {% endif %}
                        </td>
                        
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="viewTradeDetails({{ trade.id }})" class="btn btn-outline" style="padding: 6px 12px; font-size: 14px;">
                                    <i class="fas fa-eye" style="margin-right: 4px;"></i>Details
                                </button>
                                {% if not trade.verified %}
                                <form method="POST" action="{{ url_for('verify_trade', trade_id=trade.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                        <i class="fas fa-check" style="margin-right: 4px;"></i>Verify
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if trades.pages > 1 %}
        <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 32px;">
            {% if trades.has_prev %}
                <a href="{{ url_for('admin_trades', page=trades.prev_num) }}" class="btn btn-outline" style="padding: 8px 12px;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {% endif %}
            
            {% for page_num in trades.iter_pages() %}
                {% if page_num %}
                    {% if page_num != trades.page %}
                        <a href="{{ url_for('admin_trades', page=page_num) }}" class="btn btn-secondary" style="padding: 8px 12px;">{{ page_num }}</a>
                    {% else %}
                        <span class="btn btn-primary" style="padding: 8px 12px;">{{ page_num }}</span>
                    {% endif %}
                {% else %}
                    <span style="padding: 8px;">â€¦</span>
                {% endif %}
            {% endfor %}
            
            {% if trades.has_next %}
                <a href="{{ url_for('admin_trades', page=trades.next_num) }}" class="btn btn-outline" style="padding: 8px 12px;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div style="text-align: center; padding: 60px; color: var(--tradesos-gray-text);">
            <i class="fas fa-users" style="font-size: 64px; margin-bottom: 24px; opacity: 0.5;"></i>
            <h3 style="margin-bottom: 12px;">No trade applications yet</h3>
            <p>Trade professionals will appear here once they register</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Trade Details Modal -->
<div id="tradeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeTradeModal()">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: var(--border-radius-large); max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
        <div style="padding: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: var(--tradesos-black);">Trade Details</h2>
                <button onclick="closeTradeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--tradesos-gray-text);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="tradeDetails">
                <!-- Trade details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function filterTrades(status) {
    const rows = document.querySelectorAll('.trade-row');
    rows.forEach(row => {
        if (status === '') {
            row.style.display = '';
        } else if (status === 'verified') {
            row.style.display = row.dataset.verified === 'true' ? '' : 'none';
        } else if (status === 'pending') {
            row.style.display = row.dataset.verified === 'false' ? '' : 'none';
        }
    });
}

function viewTradeDetails(tradeId) {
    fetch(`/admin/trade-details/${tradeId}`)
        .then(response => response.json())
        .then(data => {
            const detailsHtml = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--tradesos-black);">Company Information</h4>
                        <div style="background: var(--tradesos-gray); padding: 16px; border-radius: var(--border-radius);">
                            <p><strong>Company:</strong> ${data.company}</p>
                            <p><strong>Email:</strong> ${data.email || 'Not provided'}</p>
                            <p><strong>Companies House:</strong> ${data.companies_house_number || 'Not provided'}</p>
                            <p><strong>VAT Number:</strong> ${data.vat_number || 'Not provided'}</p>
                            <p><strong>UTR Number:</strong> ${data.utr_number || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--tradesos-black);">Service Details</h4>
                        <div style="background: var(--tradesos-gray); padding: 16px; border-radius: var(--border-radius);">
                            <p><strong>Skills:</strong></p>
                            <div style="margin-bottom: 12px;">
                                ${data.skills.map(skill => `<span style="background: white; padding: 4px 8px; border-radius: 4px; margin-right: 4px; font-size: 12px;">${skill}</span>`).join('')}
                            </div>
                            <p><strong>Coverage Areas:</strong></p>
                            <div style="margin-bottom: 12px;">
                                ${data.coverage_areas.map(area => `<span style="background: white; padding: 4px 8px; border-radius: 4px; margin-right: 4px; font-size: 12px;">${area}</span>`).join('')}
                            </div>
                            <p><strong>Service Radius:</strong> ${data.radius_km || 25} km</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 12px; color: var(--tradesos-black);">Documentation</h4>
                    <div style="background: var(--tradesos-gray); padding: 16px; border-radius: var(--border-radius);">
                        <p><strong>Insurance Document:</strong> 
                            ${data.insurance_document_url ? 
                                `<a href="/view-document?path=${data.insurance_document_url}" target="_blank" style="color: var(--tradesos-red); margin-left: 8px;"><i class="fas fa-external-link-alt"></i> View Document</a>` : 
                                '<span style="color: var(--tradesos-gray-text);">Not uploaded</span>'}
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('tradeDetails').innerHTML = detailsHtml;
            document.getElementById('tradeModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading trade details');
        });
}

function closeTradeModal() {
    document.getElementById('tradeModal').style.display = 'none';
}
</script>
{% endblock %}