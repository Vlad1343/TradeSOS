{% extends "base_checkatrade.html" %}

{% block title %}Find Trade Professionals - TradeSOS{% endblock %}

{% block content %}
<!-- Hero Header -->
<section class="hero-brief">
    <div class="container">
        <div class="hero-inner">
            <h1 class="hero-title">Find Verified Trade Professionals</h1>
            <p class="hero-sub">Browse our directory of verified emergency trade professionals across the UK</p>
        </div>
    </div>
</section>

<!-- Search and Filters -->
<section class="categories-section">
    <div class="container">
        <div class="search-card">
            <h3 class="search-heading"><i class="fas fa-filter icon-filter"></i>Find Your Trade Professional</h3>
            <form method="GET" class="search-form-grid">
                <div>
                    <label class="form-label">Search</label>
                    <input type="text" name="search" class="form-control" placeholder="Company name or skills" value="{{ search }}">
                </div>
                <div>
                    <label class="form-label">Area</label>
                    <select name="area" class="form-control">
                        <option value="">All Areas</option>
                        <option value="M" {{ 'selected' if area == 'M' }}>Manchester</option>
                        <option value="CH" {{ 'selected' if area == 'CH' }}>Cheshire</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Service Type</label>
                    <select name="service" class="form-control">
                        <option value="">All Services</option>
                        <option value="plumbing" {{ 'selected' if request.args.get('service') == 'plumbing' }}>Plumbing</option>
                        <option value="electrical" {{ 'selected' if request.args.get('service') == 'electrical' }}>Electrical</option>
                        <option value="heating" {{ 'selected' if request.args.get('service') == 'heating' }}>Heating & Gas</option>
                        <option value="locksmith" {{ 'selected' if request.args.get('service') == 'locksmith' }}>Locksmith</option>
                        <option value="glazing" {{ 'selected' if request.args.get('service') == 'glazing' }}>Glazing</option>
                        <option value="roofing" {{ 'selected' if request.args.get('service') == 'roofing' }}>Roofing</option>
                    </select>
                </div>
                <div class="search-actions">
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Results -->
<section class="categories-section" style="padding-top: 20px;">
    <div class="container">
        <div class="results-header">
            <h2 class="section-title">
                {% if trades.items %}
                    {# Compute start/end for current page: shows "Showing X–Y of Z" #}
                    {% set start = (trades.page - 1) * trades.per_page + 1 %}
                    {% set end = start + (trades.items|length) - 1 %}
                    Showing {{ start }}–{{ end }} of {{ trades.total }} verified professionals
                {% else %}
                    No trade professionals found
                {% endif %}
            </h2>
            {# Top join button removed to avoid duplication with bottom CTA #}
        </div>
        </div>

        <!-- Trade Cards -->
        {% if trades.items %}
        <div class="categories-grid">
            {% for trade in trades.items %}
            <div class="category-card">
                <div class="card-summary">
                    <div>
                        <h3 class="company-name">{{ trade.company }}</h3>
                        <div class="company-type">{{ trade.get_skills()[0].title() if trade.get_skills() else 'General' }}</div>
                    </div>
                    <div>
                        <button class="show-more-btn" type="button">Show more</button>
                    </div>
                </div>

                <div class="card-details">
                    {% if trade.get_coverage_areas() %}
                    <div>
                        <h4 class="small-heading">Coverage Areas</h4>
                        <div>
                            {% for area in trade.get_coverage_areas()[:5] %}
                                <span class="area-badge">{{ area }}</span>
                            {% endfor %}
                            {% if trade.get_coverage_areas()|length > 5 %}
                                <span class="muted">+{{ trade.get_coverage_areas()|length - 5 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="member-since">
                        <small><i class="fas fa-calendar"></i> Member since {{ trade.created_at.strftime('%B %Y') }}</small>
                    </div>

                    <div class="card-actions">
                        {% if current_user.is_authenticated and current_user.role == 'customer' %}
                            <a href="{{ url_for('create_job') }}" class="category-btn primary"> <i class="fas fa-plus-circle"></i> Create Emergency Job</a>
                        {% elif not current_user.is_authenticated %}
                            <a href="{{ url_for('register') }}" class="category-btn outline"> <i class="fas fa-user-plus"></i> Sign Up to Contact</a>
                        {% else %}
                            <div class="muted" style="padding:12px 0;">Contact via emergency job system</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if trades.pages > 1 %}
        <div style="text-align: center; margin-top: 48px;">
            <nav aria-label="Trade directory pagination">
                <div style="display: inline-flex; gap: 8px; align-items: center;">
                    {% if trades.has_prev %}
                        <a href="{{ url_for('trade_directory', page=trades.prev_num, search=search, area=area, service=request.args.get('service')) }}" class="page-link"> <i class="fas fa-chevron-left"></i> Previous</a>
                    {% endif %}

                    {% for page_num in trades.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != trades.page %}
                                <a href="{{ url_for('trade_directory', page=page_num, search=search, area=area, service=request.args.get('service')) }}" class="page-link">{{ page_num }}</a>
                            {% else %}
                                <span class="page-current">{{ page_num }}</span>
                            {% endif %}
                        {% else %}
                            <span class="page-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}

                    {% if trades.has_next %}
                        <a href="{{ url_for('trade_directory', page=trades.next_num, search=search, area=area, service=request.args.get('service')) }}" class="page-link">Next <i class="fas fa-chevron-right"></i></a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <!-- No Results -->
        <div class="no-results" style="text-align: center; padding: 48px 20px; border: 2px solid var(--tradesos-gray-dark); border-radius: 8px; background: var(--tradesos-gray-light);">
            <i class="fas fa-search" style="font-size: 56px; color: var(--tradesos-gray-text); margin-bottom: 18px;"></i>
            <h3 style="color: var(--tradesos-black); margin-bottom: 12px; font-size: 22px;">No Trade Professionals Found</h3>
            <div class="no-results-inner" style="max-width:820px; margin:0 auto;">
                <p style="color: var(--tradesos-gray-text); margin: 0; font-size: 16px; flex:1;">
                    {% if search or area %}
                        No verified trade professionals match your search criteria. Try adjusting your filters.
                    {% else %}
                        No verified trade professionals are currently listed in our directory.
                    {% endif %}
                </p>

                <div class="no-results-actions" style="display:flex; gap:12px; align-items:center; margin-top:16px;">
                    {% if search or area %}
                        <a href="{{ url_for('trade_directory') }}" class="btn btn-outline no-results-btn">
                            <i class="fas fa-undo" style="margin-right: 8px;"></i>Clear Filters
                        </a>
                    {% endif %}

                    {% if not current_user.is_authenticated or current_user.role == 'customer' %}
                        <a href="{{ url_for('create_job') if current_user.is_authenticated else url_for('register') }}" 
                           class="btn btn-primary no-results-btn">
                            <i class="fas fa-{{ 'plus-circle' if current_user.is_authenticated else 'user-plus' }}" style="margin-right: 8px;"></i>
                            {{ 'Create Emergency Job' if current_user.is_authenticated else 'Sign Up as Customer' }}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Call to Action for Trades -->
{% if not current_user.is_authenticated or current_user.role != 'trade' %}
<section class="categories-section cta-trades" style="background: var(--tradesos-red); color: var(--tradesos-white);">
    <div class="container">
        <div style="text-align: center; max-width: 800px; margin: 0 auto;">
            <h2 style="font-size: 32px; font-weight: 600; margin-bottom: 16px; color: var(--tradesos-white);">Are you a Trade Professional?</h2>
            <p style="font-size: 18px; margin-bottom: 48px; color: var(--tradesos-white); opacity: 0.9;">Join TradeSOS and start receiving emergency job notifications in your area.</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; margin-bottom: 48px;">
                <div style="text-align: center;">
                    <i class="fas fa-bell" style="font-size: 32px; margin-bottom: 16px; color: var(--tradesos-white);"></i>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--tradesos-white);">Instant Notifications</h3>
                    <p style="font-size: 14px; color: var(--tradesos-white); opacity: 0.8;">Get notified of emergency jobs in your area</p>
                </div>
                <div style="text-align: center;">
                    <i class="fas fa-crown" style="font-size: 32px; margin-bottom: 16px; color: var(--tradesos-white);"></i>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--tradesos-white);">Premium Benefits</h3>
                    <p style="font-size: 14px; color: var(--tradesos-white); opacity: 0.8;">Priority access and higher rankings</p>
                </div>
                <div style="text-align: center;">
                    <i class="fas fa-star" style="font-size: 32px; margin-bottom: 16px; color: var(--tradesos-white);"></i>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--tradesos-white);">Build Reputation</h3>
                    <p style="font-size: 14px; color: var(--tradesos-white); opacity: 0.8;">Customer reviews and ratings</p>
                </div>
            </div>
            
            <a href="{{ url_for('register') }}?role=trade" class="join-cta" style="background: var(--tradesos-white); color: var(--tradesos-red); padding: 16px 32px; border-radius: 8px; text-decoration: none; font-size: 18px; font-weight: 600; display: inline-flex; align-items: center;">
                <i class="fas fa-tools" style="margin-right: 12px;"></i>Join as Trade Professional
            </a>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
.search-card {
    background: var(--tradesos-white);
    border: 2px solid var(--tradesos-gray-dark);
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rating .fa-star {
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .search-card form {
        display: block !important;
    }
    
    .search-card form > div {
        margin-bottom: 16px;
    }
}

/* Trade directory layout improvements */
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}
.category-card {
    background: var(--tradesos-white);
    border: 1px solid var(--tradesos-gray-dark);
    border-radius: 8px;
    padding: 12px 14px;
    box-shadow: none;
    display: block;
    gap: 8px;
}
.card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; gap:12px; }
.company-name { font-size:18px; font-weight:700; margin:0; color:var(--tradesos-black); }
.badges { display:flex; gap:8px; align-items:center; }
.verified-badge, .premium-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.verified-badge { background:#28a745; color:#fff; }
.premium-badge { background:#ffc107; color:#212529; }
.skill-badge { background:var(--tradesos-gray-light); color:var(--tradesos-black); padding:6px 10px; border-radius:999px; font-size:13px; margin-right:6px; margin-bottom:6px; display:inline-block; }
.area-badge { background:#e3f2fd; color:#1976d2; padding:6px 10px; border-radius:999px; font-size:13px; margin-right:6px; margin-bottom:6px; display:inline-block; }
.member-since small { color:var(--tradesos-gray-text); font-size:13px; }
.category-btn { display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:700; font-size:14px; }
.category-btn.primary { background:var(--tradesos-red); color:#fff; border:2px solid var(--tradesos-red); }
.category-btn.outline { background:transparent; color:var(--tradesos-red); border:2px solid var(--tradesos-red); }

@media (max-width: 600px) {
    .card-header { flex-direction:column; align-items:flex-start; }
    .badges { margin-top:8px; }
}

/* Global hero/search/result styles */
.hero-brief { background: var(--tradesos-gray); padding: 56px 0 36px 0; border-bottom: 1px solid var(--tradesos-gray-dark); }
.hero-inner { text-align: center; max-width: 820px; margin: 0 auto; }
.hero-title { font-size: 34px; font-weight: 700; margin-bottom: 10px; color: var(--tradesos-black); }
.hero-sub { font-size: 16px; color: var(--tradesos-gray-text); margin: 0; }

.search-heading { color: var(--tradesos-black); margin-bottom: 18px; font-size: 20px; font-weight: 700; }
.search-heading .icon-filter { color: var(--tradesos-red); margin-right: 8px; }

.search-form-grid { display: grid; grid-template-columns: 1fr 220px 220px 160px; gap: 12px; align-items: end; }
.form-label { display:block; margin-bottom:6px; font-weight:600; color:var(--tradesos-black); font-size:13px; }
.form-control { width:100%; padding:10px 12px; border:1px solid var(--tradesos-gray-dark); border-radius:6px; font-size:14px; }
.search-actions { display:flex; align-items:center; justify-content:flex-end; }
.search-btn { padding: 10px 18px; font-size:15px; font-weight:700; background:var(--tradesos-red); color:#fff; border:none; border-radius:8px; display:inline-flex; gap:8px; align-items:center; }

.results-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; gap:16px; }
.results-header .section-title { margin:0; font-size:18px; font-weight:700; }
.join-trade { padding: 8px 14px; border-radius: 8px; border: 2px solid var(--tradesos-gray-dark); background:transparent; color:var(--tradesos-black); font-weight:700; }

.pagination { display:inline-flex; gap:8px; align-items:center; }
.page-link { padding:8px 12px; background:var(--tradesos-white); border:1px solid var(--tradesos-gray-dark); border-radius:6px; text-decoration:none; color:var(--tradesos-black); font-size:14px; }
.page-current { padding:8px 12px; background:var(--tradesos-red); border:1px solid var(--tradesos-red); border-radius:6px; color:var(--tradesos-white); font-size:14px; }
.page-ellipsis { padding:8px 12px; color:var(--tradesos-gray-text); font-size:14px; }

.no-results { text-align:center; padding:60px 20px; border:1px solid var(--tradesos-gray-dark); border-radius:8px; background:var(--tradesos-gray); }
.no-results h3 { font-size:22px; margin-bottom:12px; }
.no-results p { font-size:15px; color:var(--tradesos-gray-text); max-width:520px; margin:0 auto 20px; }

/* No-results inline action styling: remove default blue links and avoid stacking below text */
.no-results { text-align: center; }
.no-results-inner { display:flex; flex-direction:column; gap:12px; align-items:center; }
.no-results .no-results-actions { margin-top: 16px; }
.no-results .no-results-btn { text-decoration:none; font-weight:700; border-radius:6px; padding:8px 12px; border:1px solid var(--tradesos-gray-dark); background:transparent; color:var(--tradesos-black); }
.no-results .no-results-btn.btn-primary { background:var(--tradesos-red); color:#fff; border-color:var(--tradesos-red); }


/* Ensure icons in buttons don't cause overflow */
.category-btn i, .search-btn i, .page-link i { margin-right:8px; }

@media (max-width: 900px) {
    .search-form-grid { grid-template-columns: 1fr 160px 160px 120px; }
}
@media (max-width: 700px) {
    .search-form-grid { grid-template-columns: 1fr; }
    .search-actions { justify-content: center; }
    .results-header { flex-direction:column; align-items:flex-start; }
}

/* Space adjustments requested */
.search-card { margin-top: 28px; }
.categories-section { padding-top: 18px; }

/* CTA red section spacing */
.cta-trades { padding-top: 48px; padding-bottom: 44px; }
.cta-trades .join-cta { margin-bottom: 28px; }

/* Card summary and details */
.card-summary { display:flex; justify-content:space-between; align-items:center; gap:12px; cursor: pointer; }
.card-summary:hover { background: rgba(0,0,0,0.02); }
.company-type { color:var(--tradesos-gray-text); font-size:13px; margin-top:6px; }
.small-heading { font-size:13px; color:var(--tradesos-gray-text); margin:12px 0 8px; text-transform:uppercase; }
.muted { color:var(--tradesos-gray-text); font-size:13px; }
.card-details { margin-top:12px; }
.card-actions { margin-top:12px; display:flex; gap:10px; }
.show-more-btn { background:transparent; border:1px solid var(--tradesos-gray-dark); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; font-family: 'Good Times Rg', 'Open Sans', Arial, sans-serif; }

/* Make list rows more compact with a subtle divider */
.categories-grid { display: block; }
.category-card { border-left: 4px solid transparent; margin-bottom: 8px; }
.category-card + .category-card { border-top: 1px solid var(--tradesos-gray-dark); }
.card-summary { padding: 8px 6px; }
.card-details { /* collapsed by default */
    max-height: 0;
    overflow: hidden;
    padding: 0 6px;
    background: #fafafa;
    border-radius: 6px;
    transition: max-height 0.32s ease, padding 0.32s ease;
}
.category-card.open .card-details {
    max-height: 800px; /* large enough to show content */
    padding: 10px 6px;
}
</style>
<script>
// Toggle show more details per card with slide animation (inline)
document.addEventListener('click', function (e) {
    // If click happened inside an anchor (future links) - let navigation occur
    if (e.target.closest('a')) return;

    // Toggle when clicking the show-more button or anywhere inside the summary row
    var summary = e.target.closest('.card-summary');
    if (!summary) return;

    var card = summary.closest('.category-card');
    if (!card) return;

    var btn = card.querySelector('.show-more-btn');
    var isOpen = card.classList.contains('open');
    if (isOpen) {
        card.classList.remove('open');
        if (btn) btn.textContent = 'Show more';
    } else {
        card.classList.add('open');
        if (btn) btn.textContent = 'Show less';
    }
});
</script>
{% endblock %}
